<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API配置 - 吾家有女初长成</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B0000',
                        secondary: '#DAA520',
                        accent: '#4B0082',
                        light: '#FFF8DC',
                        dark: '#2F1B14',
                        muted: '#8B7355'
                    },
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                        serif: ['SimSun', 'serif'],
                        fangsong: ['FangSong', 'serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .text-shadow-sm {
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
            .border-double-gold {
                box-shadow: 0 0 0 2px #DAA520, 0 0 0 4px #FFF8DC;
            }
            .scrollbar-hidden::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hidden {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
        
        /* 自定义动画 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(218, 165, 32, 0.5); }
            50% { box-shadow: 0 0 20px rgba(218, 165, 32, 0.8); }
            100% { box-shadow: 0 0 5px rgba(218, 165, 32, 0.5); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-in-out;
        }
        
        .animate-slideIn {
            animation: slideIn 0.8s ease-out;
        }
        
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .animate-glow {
            animation: glow 2s infinite;
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* 古风按钮样式 */
        .btn-ancient {
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .btn-ancient:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .btn-ancient:hover:before {
            left: 100%;
        }
        
        .btn-ancient:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn-ancient:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        /* 卡片样式 */
        .ancient-card {
            background-color: rgba(255, 248, 220, 0.9);
            border: 1px solid #DAA520;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .ancient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 输入框样式 */
        .input-ancient {
            transition: all 0.3s ease;
            border: 1px solid #DAA520;
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .input-ancient:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
        }
        
        /* 选择框样式 */
        .select-ancient {
            transition: all 0.3s ease;
            border: 1px solid #DAA520;
            background-color: rgba(255, 255, 255, 0.8);
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%238B0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        
        .select-ancient:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
        }
        
        /* 通知提示样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .notification.warning {
            background-color: #f59e0b;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
        
        /* 加载动画 */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #8B0000;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 切换开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #8B0000;
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #8B0000;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* API状态指示器 */
        .api-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .api-status.connected {
            background-color: #10b981;
        }
        
        .api-status.disconnected {
            background-color: #ef4444;
        }
        
        .api-status.testing {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="bg-light font-serif text-dark min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-dark text-light shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap items-center justify-between py-3">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <span class="text-2xl font-bold text-secondary mr-2">吾家有女初长成</span>
                        <i class="fa fa-gamepad text-secondary text-xl"></i>
                    </a>
                </div>
                
                <!-- 导航链接 -->
                <div class="hidden md:flex space-x-6 items-center">
                    <a href="index.html" class="text-light hover:text-secondary transition-colors duration-300">首页</a>
                    <a href="instructions.html" class="text-light hover:text-secondary transition-colors duration-300">游戏介绍</a>
                    <a href="api-config.html" class="text-secondary font-bold transition-colors duration-300">API配置</a>
                    <a href="#" class="text-light hover:text-secondary transition-colors duration-300">作者信息</a>
                </div>
                
                <!-- 移动端菜单按钮 -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-light hover:text-secondary focus:outline-none">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- 移动端菜单 -->
            <div id="mobile-menu" class="md:hidden hidden pb-3">
                <a href="index.html" class="block py-2 text-light hover:text-secondary transition-colors duration-300">首页</a>
                <a href="instructions.html" class="block py-2 text-light hover:text-secondary transition-colors duration-300">游戏介绍</a>
                <a href="api-config.html" class="block py-2 text-secondary font-bold transition-colors duration-300">API配置</a>
                <a href="#" class="block py-2 text-light hover:text-secondary transition-colors duration-300">作者信息</a>
            </div>
        </div>
    </nav>
    
    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 页面标题 -->
            <div class="text-center mb-8 animate-fadeIn">
                <h1 class="text-3xl md:text-4xl font-bold text-primary mb-2">API配置</h1>
                <p class="text-muted">配置AI服务提供商，以启用游戏中的AI驱动剧情生成功能</p>
            </div>
            
            <!-- API配置卡片 -->
            <div class="ancient-card p-6 mb-8 animate-slideIn">
                <h2 class="text-2xl font-bold text-primary mb-6 flex items-center">
                    <i class="fa fa-cogs mr-2"></i>AI服务提供商配置
                </h2>
                
                <!-- API提供商选择 -->
                <div class="mb-8">
                    <label for="api-provider" class="block text-lg font-bold mb-2">选择AI服务提供商</label>
                    <select id="api-provider" class="select-ancient w-full p-3 rounded-lg">
                        <option value="deepseek">DeepSeek</option>
                        <option value="huoshan">火山引擎</option>
                        <option value="openai">OpenAI</option>
                        <option value="siliconflow">硅基流动</option>
                        <option value="custom">自定义API</option>
                    </select>
                </div>
                
                <!-- API配置表单 -->
                <div id="api-config-form">
                    <!-- DeepSeek配置 -->
                    <div id="deepseek-config" class="api-config-section">
                        <div class="mb-4">
                            <label for="deepseek-api-key" class="block text-lg font-bold mb-2">API密钥</label>
                            <input type="password" id="deepseek-api-key" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的DeepSeek API密钥">
                        </div>
                        <div class="mb-4">
                            <label for="deepseek-model" class="block text-lg font-bold mb-2">模型选择</label>
                            <select id="deepseek-model" class="select-ancient w-full p-3 rounded-lg">
                                <option value="deepseek-chat">DeepSeek-Chat</option>
                                <option value="deepseek-vl">DeepSeek-VL</option>
                                <option value="deepseek-llm-7b-chat">DeepSeek-LLM-7B-Chat</option>
                                <option value="deepseek-llm-16b-chat">DeepSeek-LLM-16B-Chat</option>
                                <option value="deepseek-llm-72b-chat">DeepSeek-LLM-72B-Chat</option>
                                <option value="deepseek-V3.2">DeepSeek-V3.2</option>
                                <option value="custom">自定义模型</option>
                            </select>
                        </div>
                        <div id="deepseek-custom-model-container" class="mb-4 hidden">
                            <label for="deepseek-custom-model" class="block text-lg font-bold mb-2">自定义模型名称</label>
                            <input type="text" id="deepseek-custom-model" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入自定义模型名称">
                        </div>
                        <div class="mb-4">
                            <label for="deepseek-api-base" class="block text-lg font-bold mb-2">API基础URL</label>
                            <input type="text" id="deepseek-api-base" class="input-ancient w-full p-3 rounded-lg" value="https://api.deepseek.com/v1" placeholder="API基础URL">
                        </div>
                    </div>
                    
                    <!-- 火山引擎配置 -->
                    <div id="huoshan-config" class="api-config-section hidden">
                        <div class="mb-4">
                            <label for="huoshan-api-key" class="block text-lg font-bold mb-2">API密钥</label>
                            <input type="password" id="huoshan-api-key" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的火山引擎API密钥">
                        </div>
                        <div class="mb-4">
                            <label for="huoshan-model" class="block text-lg font-bold mb-2">模型选择</label>
                            <select id="huoshan-model" class="select-ancient w-full p-3 rounded-lg">
                                <option value="volcengine_gpt_4o">火山GPT-4o</option>
                                <option value="volcengine_gpt_3_5_turbo">火山GPT-3.5-Turbo</option>
                                <option value="volcengine_llama_3_70b">火山Llama-3-70B</option>
                                <option value="custom">自定义模型</option>
                            </select>
                        </div>
                        <div id="huoshan-custom-model-container" class="mb-4 hidden">
                            <label for="huoshan-custom-model" class="block text-lg font-bold mb-2">自定义模型名称</label>
                            <input type="text" id="huoshan-custom-model" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入自定义模型名称">
                        </div>
                        <div class="mb-4">
                            <label for="huoshan-api-base" class="block text-lg font-bold mb-2">API基础URL</label>
                            <input type="text" id="huoshan-api-base" class="input-ancient w-full p-3 rounded-lg" value="https://ark.cn-beijing.volces.com/api/v3" placeholder="API基础URL">
                        </div>
                        <div class="mb-4">
                            <label for="huoshan-organization-id" class="block text-lg font-bold mb-2">组织ID</label>
                            <input type="text" id="huoshan-organization-id" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的组织ID">
                        </div>
                    </div>
                    
                    <!-- OpenAI配置 -->
                    <div id="openai-config" class="api-config-section hidden">
                        <div class="mb-4">
                            <label for="openai-api-key" class="block text-lg font-bold mb-2">API密钥</label>
                            <input type="password" id="openai-api-key" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的OpenAI API密钥">
                        </div>
                        <div class="mb-4">
                            <label for="openai-model" class="block text-lg font-bold mb-2">模型选择</label>
                            <select id="openai-model" class="select-ancient w-full p-3 rounded-lg">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4-turbo">GPT-4-Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                                <option value="gpt-3.5-turbo-16k">GPT-3.5-Turbo-16K</option>
                                <option value="custom">自定义模型</option>
                            </select>
                        </div>
                        <div id="openai-custom-model-container" class="mb-4 hidden">
                            <label for="openai-custom-model" class="block text-lg font-bold mb-2">自定义模型名称</label>
                            <input type="text" id="openai-custom-model" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入自定义模型名称">
                        </div>
                        <div class="mb-4">
                            <label for="openai-api-base" class="block text-lg font-bold mb-2">API基础URL</label>
                            <input type="text" id="openai-api-base" class="input-ancient w-full p-3 rounded-lg" value="https://api.openai.com/v1" placeholder="API基础URL">
                        </div>
                        <div class="mb-4">
                            <label for="openai-organization-id" class="block text-lg font-bold mb-2">组织ID (可选)</label>
                            <input type="text" id="openai-organization-id" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的组织ID（可选）">
                        </div>
                    </div>
                    
                    <!-- 硅基流动配置 -->
                    <div id="siliconflow-config" class="api-config-section hidden">
                        <div class="mb-4">
                            <label for="siliconflow-api-key" class="block text-lg font-bold mb-2">API密钥</label>
                            <input type="password" id="siliconflow-api-key" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的硅基流动API密钥">
                        </div>
                        <div class="mb-4">
                            <label for="siliconflow-model" class="block text-lg font-bold mb-2">模型选择</label>
                            <select id="siliconflow-model" class="select-ancient w-full p-3 rounded-lg">
                                <option value="deepseek-V3.2">DeepSeek-V3.2</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                                <option value="claude-3-opus">Claude-3-Opus</option>
                                <option value="claude-3-sonnet">Claude-3-Sonnet</option>
                                <option value="gemini-pro">Gemini-Pro</option>
                                <option value="custom">自定义模型</option>
                            </select>
                        </div>
                        <div id="siliconflow-custom-model-container" class="mb-4 hidden">
                            <label for="siliconflow-custom-model" class="block text-lg font-bold mb-2">自定义模型名称</label>
                            <input type="text" id="siliconflow-custom-model" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入自定义模型名称">
                        </div>
                        <div class="mb-4">
                            <label for="siliconflow-api-base" class="block text-lg font-bold mb-2">API基础URL</label>
                            <input type="text" id="siliconflow-api-base" class="input-ancient w-full p-3 rounded-lg" value="https://api.siliconflow.cn/v1" placeholder="API基础URL">
                        </div>
                    </div>
                    
                    <!-- 自定义API配置 -->
                    <div id="custom-config" class="api-config-section hidden">
                        <div class="mb-4">
                            <label for="custom-api-name" class="block text-lg font-bold mb-2">API名称</label>
                            <input type="text" id="custom-api-name" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入API名称">
                        </div>
                        <div class="mb-4">
                            <label for="custom-api-key" class="block text-lg font-bold mb-2">API密钥</label>
                            <input type="password" id="custom-api-key" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入您的API密钥">
                        </div>
                        <div class="mb-4">
                            <label for="custom-api-base" class="block text-lg font-bold mb-2">API基础URL</label>
                            <input type="text" id="custom-api-base" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入API基础URL">
                        </div>
                        <div class="mb-4">
                            <label for="custom-model" class="block text-lg font-bold mb-2">模型名称</label>
                            <input type="text" id="custom-model" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入模型名称">
                        </div>
                        <div class="mb-4">
                            <label for="custom-request-format" class="block text-lg font-bold mb-2">请求格式</label>
                            <select id="custom-request-format" class="select-ancient w-full p-3 rounded-lg">
                                <option value="openai">OpenAI格式</option>
                                <option value="azure">Azure格式</option>
                                <option value="anthropic">Anthropic格式</option>
                                <option value="custom">自定义格式</option>
                            </select>
                        </div>
                        <div id="custom-format-template-container" class="mb-4 hidden">
                            <label for="custom-format-template" class="block text-lg font-bold mb-2">自定义请求模板 (JSON)</label>
                            <textarea id="custom-format-template" class="input-ancient w-full p-3 rounded-lg h-32" placeholder='请输入自定义请求模板，例如: {"model": "{{model}}", "messages": {{messages}}, "temperature": {{temperature}}}'></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- 高级设置 -->
                <div class="mt-8 border-t border-gray-300 pt-6">
                    <h3 class="text-xl font-bold text-primary mb-4">高级设置</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label for="temperature" class="text-lg font-bold">生成温度</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="w-1/2">
                            <span id="temperature-value" class="text-lg font-bold">0.7</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="max-tokens" class="text-lg font-bold">最大令牌数</label>
                            <input type="number" id="max-tokens" min="50" max="4000" step="50" value="1000" class="input-ancient w-1/3 p-2 rounded-lg">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="top-p" class="text-lg font-bold">Top P</label>
                            <input type="range" id="top-p" min="0" max="1" step="0.1" value="1" class="w-1/2">
                            <span id="top-p-value" class="text-lg font-bold">1</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="frequency-penalty" class="text-lg font-bold">频率惩罚</label>
                            <input type="range" id="frequency-penalty" min="-2" max="2" step="0.1" value="0" class="w-1/2">
                            <span id="frequency-penalty-value" class="text-lg font-bold">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="presence-penalty" class="text-lg font-bold">存在惩罚</label>
                            <input type="range" id="presence-penalty" min="-2" max="2" step="0.1" value="0" class="w-1/2">
                            <span id="presence-penalty-value" class="text-lg font-bold">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 按钮组 -->
                <div class="mt-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="api-passphrase" class="block text-lg font-bold mb-2">本地密钥保护口令</label>
                            <input type="password" id="api-passphrase" class="input-ancient w-full p-3 rounded-lg" placeholder="请输入用于本地加密的口令">
                        </div>
                        <div class="md:col-span-2 flex items-center">
                            <input type="checkbox" id="api-passphrase-keep-session" class="mr-2">
                            <label for="api-passphrase-keep-session">本会话保持解锁（便于游戏页直接使用）</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-between gap-4">
                    <button id="test-api-btn" class="btn-ancient bg-secondary hover:bg-yellow-600 text-dark font-bold py-3 px-8 rounded-lg transition-colors duration-300 inline-flex items-center">
                        <i class="fa fa-check-circle mr-2"></i>
                        <span>测试API连接</span>
                        <div id="test-api-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <button id="save-config-btn" class="btn-ancient bg-primary hover:bg-red-800 text-light font-bold py-3 px-8 rounded-lg transition-colors duration-300 inline-flex items-center">
                        <i class="fa fa-save mr-2"></i>
                        <span>保存配置</span>
                    </button>
                </div>
            </div>
            
            <!-- API状态卡片 -->
            <div class="ancient-card p-6 mb-8 animate-slideIn" style="animation-delay: 0.2s;">
                <h2 class="text-2xl font-bold text-primary mb-4 flex items-center">
                    <i class="fa fa-heartbeat mr-2"></i>API状态
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="font-bold">当前选中的API提供商</span>
                        <span id="current-provider-status" class="flex items-center">
                            <span class="api-status disconnected"></span>
                            <span>未连接</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold">API响应时间</span>
                        <span id="api-response-time">- ms</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold">最近一次API调用</span>
                        <span id="last-api-call">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold">今日API调用次数</span>
                        <span id="today-api-calls">0</span>
                    </div>
                </div>
            </div>
            
            <!-- API使用说明卡片 -->
            <div class="ancient-card p-6 animate-slideIn" style="animation-delay: 0.4s;">
                <h2 class="text-2xl font-bold text-primary mb-4 flex items-center">
                    <i class="fa fa-info-circle mr-2"></i>API使用说明
                </h2>
                <div class="space-y-4">
                    <p>1. 选择您想要使用的AI服务提供商。</p>
                    <p>2. 输入您的API密钥和其他必要的配置信息。</p>
                    <p>3. 点击"测试API连接"按钮验证您的配置是否正确。</p>
                    <p>4. 点击"保存配置"按钮保存您的设置。</p>
                    <p class="mt-6 font-bold">注意事项：</p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li>请确保您的API密钥有效且具有足够的配额。</li>
                        <li>不同的API提供商可能有不同的使用限制和费用结构。</li>
                        <li>如果您使用自定义API，请确保您了解其API格式和要求。</li>
                        <li>您的API密钥将被加密存储在本地，不会被上传到任何服务器。</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-dark text-light py-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-between items-center">
                <div class="w-full md:w-1/3 mb-4 md:mb-0 text-center md:text-left">
                    <h3 class="text-xl font-bold text-secondary mb-2">吾家有女初长成</h3>
                    <p class="text-muted">AI驱动的古风高自由度随机文字人生模拟器</p>
                </div>
                <div class="w-full md:w-1/3 mb-4 md:mb-0 text-center">
                    <h3 class="text-lg font-bold text-secondary mb-2">作者信息</h3>
                    <p class="text-muted">作者：西一</p>
                </div>
                <div class="w-full md:w-1/3 text-center md:text-right">
                    <h3 class="text-lg font-bold text-secondary mb-2">联系我们</h3>
                    <p class="text-muted">邮箱：contact@example.com</p>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-700 text-center text-muted">
                <p>&copy; 2024 吾家有女初长成 - 西一. 保留所有权利.</p>
            </div>
        </div>
    </footer>
    
    <!-- 通知提示 -->
    <div id="notification" class="notification"></div>
    
    <!-- JavaScript -->
    <script>
        // 移动端菜单切换
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });
        
        // 显示通知
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // 显示通知
            setTimeout(() => notification.classList.add('show'), 10);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.textContent = '', 300);
            }, duration);
        }
        
        // API提供商切换
        const apiProviderSelect = document.getElementById('api-provider');
        const apiConfigSections = document.querySelectorAll('.api-config-section');
        
        apiProviderSelect.addEventListener('change', function() {
            const selectedProvider = this.value;
            
            // 隐藏所有配置部分
            apiConfigSections.forEach(section => {
                section.classList.add('hidden');
            });
            
            // 显示选中的配置部分
            document.getElementById(`${selectedProvider}-config`).classList.remove('hidden');
            
            // 更新当前提供商状态
            updateCurrentProviderStatus(selectedProvider);
            
            // 加载保存的配置
            loadSavedConfig(selectedProvider);
        });
        
        // 自定义模型选择处理
        const modelSelects = document.querySelectorAll('select[id$="-model"]');
        modelSelects.forEach(select => {
            select.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                const providerId = this.id.split('-model')[0];
                const customModelContainer = document.getElementById(`${providerId}-custom-model-container`);
                
                if (customModelContainer) {
                    if (isCustom) {
                        customModelContainer.classList.remove('hidden');
                    } else {
                        customModelContainer.classList.add('hidden');
                    }
                }
            });
        });
        
        // 自定义请求格式处理
        const customRequestFormatSelect = document.getElementById('custom-request-format');
        const customFormatTemplateContainer = document.getElementById('custom-format-template-container');
        
        if (customRequestFormatSelect && customFormatTemplateContainer) {
            customRequestFormatSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customFormatTemplateContainer.classList.remove('hidden');
                } else {
                    customFormatTemplateContainer.classList.add('hidden');
                }
            });
        }
        
        // 滑块值显示
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        const topPSlider = document.getElementById('top-p');
        const topPValue = document.getElementById('top-p-value');
        const frequencyPenaltySlider = document.getElementById('frequency-penalty');
        const frequencyPenaltyValue = document.getElementById('frequency-penalty-value');
        const presencePenaltySlider = document.getElementById('presence-penalty');
        const presencePenaltyValue = document.getElementById('presence-penalty-value');
        
        if (temperatureSlider && temperatureValue) {
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
        }
        
        if (topPSlider && topPValue) {
            topPSlider.addEventListener('input', function() {
                topPValue.textContent = this.value;
            });
        }
        
        if (frequencyPenaltySlider && frequencyPenaltyValue) {
            frequencyPenaltySlider.addEventListener('input', function() {
                frequencyPenaltyValue.textContent = this.value;
            });
        }
        
        if (presencePenaltySlider && presencePenaltyValue) {
            presencePenaltySlider.addEventListener('input', function() {
                presencePenaltyValue.textContent = this.value;
            });
        }
        
        // 测试API连接
        const testApiBtn = document.getElementById('test-api-btn');
        const testApiSpinner = document.getElementById('test-api-spinner');
        const apiStatusResp = document.getElementById('api-response-time');
        const lastApiCallEl = document.getElementById('last-api-call');
        const todayApiCallsEl = document.getElementById('today-api-calls');
        
        async function deriveKey(pass, salt) {
            const enc = new TextEncoder().encode(pass);
            const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }
        async function encryptWithPass(pass, text) {
            const salt = new Uint8Array(16);
            crypto.getRandomValues(salt);
            const key = await deriveKey(pass, salt);
            const iv = new Uint8Array(12);
            crypto.getRandomValues(iv);
            const enc = new TextEncoder().encode(text);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc);
            return {
                s: btoa(String.fromCharCode(...salt)),
                i: btoa(String.fromCharCode(...iv)),
                c: btoa(String.fromCharCode(...new Uint8Array(cipher)))
            };
        }
        async function decryptWithPass(pass, payload) {
            if (!payload) return '';
            const salt = Uint8Array.from(atob(payload.s || ''), c => c.charCodeAt(0));
            const iv = Uint8Array.from(atob(payload.i || ''), c => c.charCodeAt(0));
            const ct = Uint8Array.from(atob(payload.c || ''), c => c.charCodeAt(0));
            const key = await deriveKey(pass, salt);
            const plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
            return new TextDecoder().decode(plain);
        }
        
        async function readApiKey(provider) {
            const stored = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            const fieldVal = document.getElementById(`${provider}-api-key`).value || '';
            if (stored.provider === provider && stored.apiKeyEnc) {
                const passInput = document.getElementById('api-passphrase');
                const pass = (passInput && passInput.value) || sessionStorage.getItem('apiPassphraseSession') || '';
                if (!pass) {
                    // 未解锁会话时，优先使用当前输入框中的密钥进行测试
                    return fieldVal;
                }
                try { return await decryptWithPass(pass, stored.apiKeyEnc); } catch { return fieldVal; }
            }
            return fieldVal;
        }
        
        function getModelValue(provider) {
            const sel = document.getElementById(`${provider}-model`).value;
            if (sel === 'custom') {
                const custom = document.getElementById(`${provider}-custom-model`);
                return custom ? custom.value : '';
            }
            return sel;
        }
        
        async function testProviderConnection({ provider, apiBase, model }) {
            const apiKey = await readApiKey(provider);
            if (!apiKey) throw new Error('缺少API密钥');
            const headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 12000);
            const started = performance.now();
            try {
                let url = '';
                let init = { method: 'GET', headers, signal: controller.signal };
                switch (provider) {
                    case 'openai':
                    case 'deepseek':
                    case 'siliconflow':
                        url = `${apiBase.replace(/\/$/, '')}/models`;
                        break;
                    case 'huoshan': {
                        url = `${apiBase.replace(/\/$/, '')}/chat/completions`;
                        init = {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({
                                model,
                                messages: [{ role: 'user', content: 'ping' }],
                                max_tokens: 1,
                                temperature: 0
                            }),
                            signal: controller.signal
                        };
                        break;
                    }
                    case 'custom': {
                        // 默认使用 OpenAI 兼容格式
                        url = `${apiBase.replace(/\/$/, '')}/models`;
                        break;
                    }
                    default:
                        throw new Error('未知提供商');
                }
                const res = await fetch(url, init);
                const elapsed = Math.round(performance.now() - started);
                if (!res.ok) {
                    let msg = `HTTP ${res.status}`;
                    try {
                        const text = await res.text();
                        msg += ` - ${text.slice(0, 200)}`;
                    } catch {}
                    const err = new Error(`连接失败：${msg}`);
                    err.elapsed = elapsed;
                    throw err;
                }
                // 尝试解析以确保返回有效JSON
                try { await res.clone().json(); } catch {}
                clearTimeout(timeout);
                return { ok: true, elapsed };
            } catch (e) {
                clearTimeout(timeout);
                // CORS拦截情况下会抛出 TypeError: Failed to fetch 或 AbortError
                const isCors = e instanceof TypeError && /fetch/i.test(e.message);
                const message = isCors ? '可能被浏览器的CORS策略拦截，请改用后端代理或允许跨域' : (e.message || '连接失败');
                const err = new Error(message);
                err.elapsed = Math.round(performance.now() - started);
                throw err;
            }
        }
        
        testApiBtn.addEventListener('click', async function() {
            const provider = apiProviderSelect.value;
            const apiBase = document.getElementById(`${provider}-api-base`).value;
            const model = getModelValue(provider);
            if (!apiBase) {
                showNotification('请输入API基础URL', 'warning');
                return;
            }
            if (['huoshan','custom','openai','deepseek','siliconflow'].includes(provider) && !model) {
                showNotification('请选择或填写模型名称', 'warning');
                return;
            }
            testApiSpinner.classList.remove('hidden');
            testApiBtn.disabled = true;
            updateApiStatus('testing', '测试中...');
            try {
                const result = await testProviderConnection({ provider, apiBase, model });
                updateApiStatus('connected', '已连接');
                apiStatusResp.textContent = `${result.elapsed} ms`;
                const now = new Date();
                lastApiCallEl.textContent = now.toLocaleString();
                const todayCalls = parseInt(todayApiCallsEl.textContent) + 1;
                todayApiCallsEl.textContent = todayCalls;
                showNotification('API连接测试成功', 'success');
                saveApiStatus({
                    provider,
                    status: 'connected',
                    responseTime: result.elapsed,
                    lastCall: now.toISOString(),
                    todayCalls
                });
            } catch (err) {
                updateApiStatus('disconnected', '连接失败');
                apiStatusResp.textContent = `${err.elapsed || '-'} ms`;
                showNotification(`API连接测试失败：${err.message}`, 'error');
            } finally {
                testApiSpinner.classList.add('hidden');
                testApiBtn.disabled = false;
            }
        });
        
        // 保存配置
        const saveConfigBtn = document.getElementById('save-config-btn');
        
        saveConfigBtn.addEventListener('click', async function() {
            const selectedProvider = apiProviderSelect.value;
            const apiKeyPlain = document.getElementById(`${selectedProvider}-api-key`).value;
            const passphrase = document.getElementById('api-passphrase').value;
            const keepSession = document.getElementById('api-passphrase-keep-session').checked;
            
            if (!apiKeyPlain) {
                showNotification('请输入API密钥', 'warning');
                return;
            }
            if (!passphrase) {
                showNotification('请输入本地密钥保护口令', 'warning');
                return;
            }
            
            // 收集配置数据
            const config = {
                provider: selectedProvider,
                apiKeyEnc: await encryptWithPass(passphrase, apiKeyPlain),
                model: document.getElementById(`${selectedProvider}-model`).value,
                apiBase: document.getElementById(`${selectedProvider}-api-base`).value,
                temperature: parseFloat(temperatureSlider.value),
                maxTokens: parseInt(document.getElementById('max-tokens').value),
                topP: parseFloat(topPSlider.value),
                frequencyPenalty: parseFloat(frequencyPenaltySlider.value),
                presencePenalty: parseFloat(presencePenaltySlider.value)
            };
            
            // 收集特定提供商的配置
            switch (selectedProvider) {
                case 'deepseek':
                case 'huoshan':
                case 'openai':
                case 'siliconflow':
                    if (config.model === 'custom') {
                        config.customModel = document.getElementById(`${selectedProvider}-custom-model`).value;
                    }
                    if (document.getElementById(`${selectedProvider}-organization-id`)) {
                        config.organizationId = document.getElementById(`${selectedProvider}-organization-id`).value;
                    }
                    break;
                case 'custom':
                    config.apiName = document.getElementById('custom-api-name').value;
                    config.requestFormat = document.getElementById('custom-request-format').value;
                    if (config.requestFormat === 'custom') {
                        config.formatTemplate = document.getElementById('custom-format-template').value;
                    }
                    break;
            }
            
            // 保存配置到本地存储
            try {
                localStorage.setItem('apiConfig', JSON.stringify(config));
                if (keepSession) sessionStorage.setItem('apiPassphraseSession', passphrase);
                showNotification('配置保存成功', 'success');
            } catch (error) {
                showNotification('配置保存失败', 'error');
                console.error('保存配置失败:', error);
            }
        });
        
        // 更新API状态显示
        function updateApiStatus(status, text) {
            const statusElement = document.getElementById('current-provider-status');
            const statusDot = statusElement.querySelector('.api-status');
            
            statusDot.className = `api-status ${status}`;
            statusDot.nextElementSibling.textContent = text;
        }
        
        // 保存API状态
        function saveApiStatus(status) {
            try {
                localStorage.setItem('apiStatus', JSON.stringify(status));
            } catch (error) {
                console.error('保存API状态失败:', error);
            }
        }
        
        // 加载API状态
        function loadApiStatus() {
            try {
                const status = JSON.parse(localStorage.getItem('apiStatus'));
                if (status) {
                    updateApiStatus(status.status, status.status === 'connected' ? '已连接' : '未连接');
                    document.getElementById('api-response-time').textContent = `${status.responseTime} ms`;
                    
                    if (status.lastCall) {
                        const lastCallDate = new Date(status.lastCall);
                        document.getElementById('last-api-call').textContent = lastCallDate.toLocaleString();
                    }
                    
                    if (status.todayCalls) {
                        document.getElementById('today-api-calls').textContent = status.todayCalls;
                    }
                }
            } catch (error) {
                console.error('加载API状态失败:', error);
            }
        }
        
        // 更新当前提供商状态
        function updateCurrentProviderStatus(provider) {
            try {
                const config = JSON.parse(localStorage.getItem('apiConfig'));
                if (config && config.provider === provider) {
                    updateApiStatus('connected', '已连接');
                } else {
                    updateApiStatus('disconnected', '未连接');
                }
            } catch (error) {
                updateApiStatus('disconnected', '未连接');
            }
        }
        
        // 加载保存的配置
        function loadSavedConfig(provider) {
            try {
                const config = JSON.parse(localStorage.getItem('apiConfig'));
                if (config && config.provider === provider) {
                    // 填充通用配置
                    const pass = sessionStorage.getItem('apiPassphraseSession') || '';
                    if (pass && config.apiKeyEnc) {
                        (async () => {
                            document.getElementById(`${provider}-api-key`).value = await decryptWithPass(pass, config.apiKeyEnc);
                        })();
                    } else {
                        document.getElementById(`${provider}-api-key`).value = '';
                    }
                    document.getElementById(`${provider}-model`).value = config.model || 'default';
                    document.getElementById(`${provider}-api-base`).value = config.apiBase || '';
                    
                    // 填充高级设置
                    temperatureSlider.value = config.temperature || 0.7;
                    temperatureValue.textContent = config.temperature || 0.7;
                    
                    document.getElementById('max-tokens').value = config.maxTokens || 1000;
                    
                    topPSlider.value = config.topP || 1;
                    topPValue.textContent = config.topP || 1;
                    
                    frequencyPenaltySlider.value = config.frequencyPenalty || 0;
                    frequencyPenaltyValue.textContent = config.frequencyPenalty || 0;
                    
                    presencePenaltySlider.value = config.presencePenalty || 0;
                    presencePenaltyValue.textContent = config.presencePenalty || 0;
                    
                    // 填充特定提供商的配置
                    switch (provider) {
                        case 'deepseek':
                        case 'huoshan':
                        case 'openai':
                        case 'siliconflow':
                            if (config.model === 'custom') {
                                document.getElementById(`${provider}-custom-model`).value = config.customModel || '';
                                document.getElementById(`${provider}-custom-model-container`).classList.remove('hidden');
                            }
                            if (config.organizationId && document.getElementById(`${provider}-organization-id`)) {
                                document.getElementById(`${provider}-organization-id`).value = config.organizationId;
                            }
                            break;
                        case 'custom':
                            document.getElementById('custom-api-name').value = config.apiName || '';
                            document.getElementById('custom-request-format').value = config.requestFormat || 'openai';
                            document.getElementById('custom-model').value = config.model || '';
                            
                            if (config.requestFormat === 'custom') {
                                document.getElementById('custom-format-template').value = config.formatTemplate || '';
                                customFormatTemplateContainer.classList.remove('hidden');
                            }
                            break;
                    }
                }
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('load', function() {
            // 显示默认选中的API提供商配置
            const selectedProvider = apiProviderSelect.value;
            document.getElementById(`${selectedProvider}-config`).classList.remove('hidden');
            
            // 加载保存的配置
            loadSavedConfig(selectedProvider);
            
            // 加载API状态
            loadApiStatus();
        });
    </script>
</body>
</html>

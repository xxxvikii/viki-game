<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API配置 - 吾家有女初长成</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 加载动画 -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>正在加载页面...</p>
        </div>
    </div>

    <!-- API配置页面 -->
    <div id="api-config" class="api-config-page hidden">
        <div class="container">
            <div class="page-header">
                <h1>API配置</h1>
                <p>配置AI模型接口，用于生成游戏剧情</p>
            </div>

            <div class="api-config-container">
                <!-- API服务商选择 -->
                <div class="config-section">
                    <h2 class="section-title">
                        <i class="fas fa-server"></i> 选择API服务商
                    </h2>
                    <div class="provider-options">
                        <label class="provider-option">
                            <input type="radio" name="api-provider" value="deepseek" id="provider-deepseek">
                            <div class="provider-info">
                                <div class="provider-header">
                                    <span class="provider-name">Deepseek</span>
                                    <span class="provider-status">推荐</span>
                                </div>
                                <p class="provider-desc">深度求索提供的中文大语言模型，支持最新的DeepSeek-V3.2</p>
                            </div>
                        </label>
                        <label class="provider-option">
                            <input type="radio" name="api-provider" value="huoshan" id="provider-huoshan">
                            <div class="provider-info">
                                <div class="provider-header">
                                    <span class="provider-name">火山</span>
                                    <span class="provider-status">可选</span>
                                </div>
                                <p class="provider-desc">火山引擎提供的大语言模型，支持多种应用场景</p>
                            </div>
                        </label>
                        <label class="provider-option">
                            <input type="radio" name="api-provider" value="openai" id="provider-openai">
                            <div class="provider-info">
                                <div class="provider-header">
                                    <span class="provider-name">OpenAI</span>
                                    <span class="provider-status">可选</span>
                                </div>
                                <p class="provider-desc">OpenAI提供的GPT系列模型，支持英文和中文</p>
                            </div>
                        </label>
                        <label class="provider-option">
                            <input type="radio" name="api-provider" value="guiji" id="provider-guiji">
                            <div class="provider-info">
                                <div class="provider-header">
                                    <span class="provider-name">硅基流动</span>
                                    <span class="provider-status">可选</span>
                                </div>
                                <p class="provider-desc">硅基流动提供的大语言模型，支持配置多种模型</p>
                            </div>
                        </label>
                        <label class="provider-option">
                            <input type="radio" name="api-provider" value="custom" id="provider-custom">
                            <div class="provider-info">
                                <div class="provider-header">
                                    <span class="provider-name">自定义模型</span>
                                    <span class="provider-status">高级</span>
                                </div>
                                <p class="provider-desc">手动配置自定义的AI模型接口</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- API设置 -->
                <div class="config-section">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i> API设置
                    </h2>
                    <div class="api-settings">
                        <div class="setting-group">
                            <label for="api-key">API密钥 <span class="required">*</span></label>
                            <div class="input-group">
                                <input type="password" id="api-key" placeholder="请输入API密钥" class="api-input">
                                <button class="btn btn-small btn-toggle" onclick="toggleApiKeyVisibility()">
                                    <i class="fas fa-eye" id="key-visibility-icon"></i>
                                </button>
                            </div>
                            <p class="setting-hint">API密钥是访问API的凭证，请妥善保管</p>
                        </div>

                        <div class="setting-group">
                            <label for="api-model">模型选择 <span class="required">*</span></label>
                            <select id="api-model" class="api-select">
                                <option value="deepseek-vl">DeepSeek-VL</option>
                                <option value="deepseek-llm">DeepSeek-LLM</option>
                                <option value="deepseek-v3.2" selected>DeepSeek-V3.2</option>
                            </select>
                            <p class="setting-hint">选择要使用的AI模型</p>
                        </div>

                        <div class="setting-group">
                            <label for="api-url">API地址 <span class="required">*</span></label>
                            <input type="text" id="api-url" placeholder="请输入API地址" class="api-input" value="https://api.deepseek.com/v1/chat/completions">
                            <p class="setting-hint">API的端点URL</p>
                        </div>

                        <div class="setting-group">
                            <label for="api-temperature">生成温度</label>
                            <div class="range-group">
                                <input type="range" id="api-temperature" min="0" max="1" step="0.1" value="0.7" class="api-range">
                                <span class="range-value" id="temperature-value">0.7</span>
                            </div>
                            <p class="setting-hint">控制生成内容的随机性，值越高越随机</p>
                        </div>

                        <div class="setting-group">
                            <label for="api-max-tokens">最大生成长度</label>
                            <input type="number" id="api-max-tokens" min="100" max="2000" value="500" class="api-input">
                            <p class="setting-hint">控制生成内容的最大长度，单位为token</p>
                        </div>
                    </div>
                </div>

                <!-- 高级设置 -->
                <div class="config-section">
                    <h2 class="section-title">
                        <i class="fas fa-sliders-h"></i> 高级设置
                    </h2>
                    <div class="advanced-settings">
                        <div class="setting-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enable-cache" checked>
                                <span class="checkbox-text">启用本地缓存</span>
                            </label>
                            <p class="setting-hint">缓存API响应，减少重复请求</p>
                        </div>

                        <div class="setting-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enable-logging">
                                <span class="checkbox-text">启用API日志</span>
                            </label>
                            <p class="setting-hint">记录API请求和响应日志，用于调试</p>
                        </div>

                        <div class="setting-group">
                            <label for="api-timeout">请求超时时间</label>
                            <input type="number" id="api-timeout" min="5" max="60" value="30" class="api-input">
                            <p class="setting-hint">API请求的超时时间，单位为秒</p>
                        </div>
                    </div>
                </div>

                <!-- 测试连接 -->
                <div class="config-section">
                    <h2 class="section-title">
                        <i class="fas fa-plug"></i> 测试连接
                    </h2>
                    <div class="test-section">
                        <div class="test-input">
                            <label for="test-prompt">测试提示词</label>
                            <textarea id="test-prompt" rows="3" class="api-textarea">请生成一段古代女子在花园赏花的场景描述，约200字。</textarea>
                        </div>
                        <div class="test-actions">
                            <button class="btn btn-primary" onclick="testApiConnection()">
                                <i class="fas fa-play"></i> 测试连接
                            </button>
                            <button class="btn btn-secondary" onclick="clearTestResult()">
                                <i class="fas fa-trash"></i> 清空结果
                            </button>
                        </div>
                        <div class="test-result" id="test-result">
                            <h3>测试结果</h3>
                            <div class="result-content" id="result-content">
                                <p class="empty-message">点击"测试连接"按钮开始测试</p>
                            </div>
                            <div class="result-stats" id="result-stats"></div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                        <i class="fas fa-arrow-left"></i> 返回主页
                    </button>
                    <button class="btn btn-secondary" onclick="resetToDefault()">
                        <i class="fas fa-undo"></i> 恢复默认
                    </button>
                    <button class="btn btn-primary" onclick="saveApiConfig()">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示弹窗 -->
    <div id="toast" class="toast hidden">
        <div class="toast-content">
            <i class="fas fa-check-circle toast-icon success"></i>
            <span class="toast-message">操作成功</span>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="api.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 显示加载动画
            showLoading();
            
            // 模拟加载过程
            setTimeout(function() {
                // 隐藏加载动画，显示页面
                hideLoading();
                document.getElementById('api-config').classList.remove('hidden');
                
                // 初始化API配置
                initializeApiConfig();
                
                // 绑定事件
                bindEvents();
            }, 1000);
        });
        
        // 初始化API配置
        function initializeApiConfig() {
            // 从本地存储加载配置
            const savedConfig = loadApiConfig();
            
            if (savedConfig) {
                // 设置服务商
                if (savedConfig.provider) {
                    const providerRadio = document.getElementById(`provider-${savedConfig.provider}`);
                    if (providerRadio) {
                        providerRadio.checked = true;
                    }
                }
                
                // 设置API密钥
                if (savedConfig.apiKey) {
                    document.getElementById('api-key').value = savedConfig.apiKey;
                }
                
                // 设置模型
                if (savedConfig.model) {
                    document.getElementById('api-model').value = savedConfig.model;
                }
                
                // 设置API地址
                if (savedConfig.apiUrl) {
                    document.getElementById('api-url').value = savedConfig.apiUrl;
                }
                
                // 设置温度
                if (savedConfig.temperature !== undefined) {
                    document.getElementById('api-temperature').value = savedConfig.temperature;
                    document.getElementById('temperature-value').textContent = savedConfig.temperature;
                }
                
                // 设置最大生成长度
                if (savedConfig.maxTokens) {
                    document.getElementById('api-max-tokens').value = savedConfig.maxTokens;
                }
                
                // 设置缓存
                if (savedConfig.enableCache !== undefined) {
                    document.getElementById('enable-cache').checked = savedConfig.enableCache;
                }
                
                // 设置日志
                if (savedConfig.enableLogging !== undefined) {
                    document.getElementById('enable-logging').checked = savedConfig.enableLogging;
                }
                
                // 设置超时
                if (savedConfig.timeout) {
                    document.getElementById('api-timeout').value = savedConfig.timeout;
                }
                
                // 更新模型列表
                updateModelList(savedConfig.provider);
            }
        }
        
        // 绑定事件
        function bindEvents() {
            // 服务商选择事件
            const providerRadios = document.querySelectorAll('input[name="api-provider"]');
            providerRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateModelList(this.value);
                });
            });
            
            // 温度滑块事件
            const temperatureSlider = document.getElementById('api-temperature');
            temperatureSlider.addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
            });
        }
        
        // 更新模型列表
        function updateModelList(provider) {
            const modelSelect = document.getElementById('api-model');
            modelSelect.innerHTML = '';
            
            // 根据服务商设置模型列表
            let models = [];
            
            switch (provider) {
                case 'deepseek':
                    models = [
                        { value: 'deepseek-vl', text: 'DeepSeek-VL' },
                        { value: 'deepseek-llm', text: 'DeepSeek-LLM' },
                        { value: 'deepseek-v3.2', text: 'DeepSeek-V3.2' }
                    ];
                    document.getElementById('api-url').value = 'https://api.deepseek.com/v1/chat/completions';
                    break;
                case 'huoshan':
                    models = [
                        { value: 'huoshan-llm', text: '火山-LLM' },
                        { value: 'huoshan-chat', text: '火山-Chat' }
                    ];
                    document.getElementById('api-url').value = 'https://api.huoshan.com/v1/chat/completions';
                    break;
                case 'openai':
                    models = [
                        { value: 'gpt-3.5-turbo', text: 'GPT-3.5-Turbo' },
                        { value: 'gpt-4', text: 'GPT-4' },
                        { value: 'gpt-4-turbo', text: 'GPT-4-Turbo' }
                    ];
                    document.getElementById('api-url').value = 'https://api.openai.com/v1/chat/completions';
                    break;
                case 'guiji':
                    models = [
                        { value: 'guiji-llm', text: '硅基-LLM' },
                        { value: 'deepseek-v3.2', text: 'DeepSeek-V3.2 (硅基)' },
                        { value: 'gpt-3.5-turbo', text: 'GPT-3.5-Turbo (硅基)' }
                    ];
                    document.getElementById('api-url').value = 'https://api.guiji.com/v1/chat/completions';
                    break;
                case 'custom':
                    models = [
                        { value: 'custom-model', text: '自定义模型' }
                    ];
                    // 保留用户之前输入的URL
                    break;
                default:
                    models = [
                        { value: 'deepseek-v3.2', text: 'DeepSeek-V3.2' }
                    ];
                    document.getElementById('api-url').value = 'https://api.deepseek.com/v1/chat/completions';
            }
            
            // 添加模型选项
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.text;
                modelSelect.appendChild(option);
            });
        }
        
        // 切换API密钥可见性
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('api-key');
            const visibilityIcon = document.getElementById('key-visibility-icon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                visibilityIcon.classList.remove('fa-eye');
                visibilityIcon.classList.add('fa-eye-slash');
            } else {
                apiKeyInput.type = 'password';
                visibilityIcon.classList.remove('fa-eye-slash');
                visibilityIcon.classList.add('fa-eye');
            }
        }
        
        // 测试API连接
        function testApiConnection() {
            // 获取配置
            const config = getApiConfig();
            
            // 验证配置
            if (!validateConfig(config)) {
                return;
            }
            
            // 显示加载状态
            const testResult = document.getElementById('test-result');
            const resultContent = document.getElementById('result-content');
            const resultStats = document.getElementById('result-stats');
            
            resultContent.innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner small"></div>
                    <p>正在测试API连接...</p>
                </div>
            `;
            resultStats.innerHTML = '';
            
            // 获取测试提示词
            const testPrompt = document.getElementById('test-prompt').value;
            
            // 记录开始时间
            const startTime = Date.now();
            
            // 测试API连接
            testApi(config, testPrompt)
                .then(response => {
                    // 计算耗时
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    // 显示结果
                    resultContent.innerHTML = `
                        <div class="success-message">
                            <i class="fas fa-check-circle success-icon"></i>
                            <p>API连接成功！</p>
                        </div>
                        <div class="response-content">
                            <h4>生成结果:</h4>
                            <p>${response.text.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                    
                    resultStats.innerHTML = `
                        <div class="stats-item">
                            <span class="stats-label">耗时:</span>
                            <span class="stats-value">${duration}ms</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">生成字数:</span>
                            <span class="stats-value">${response.text.length}字</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">状态:</span>
                            <span class="stats-value success">成功</span>
                        </div>
                    `;
                    
                    // 保存测试成功的配置
                    saveApiConfig();
                    
                    showToast('API连接测试成功！', 'success');
                })
                .catch(error => {
                    // 显示错误
                    resultContent.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-times-circle error-icon"></i>
                            <p>API连接失败！</p>
                            <p class="error-detail">${error.message}</p>
                        </div>
                    `;
                    
                    resultStats.innerHTML = `
                        <div class="stats-item">
                            <span class="stats-label">状态:</span>
                            <span class="stats-value error">失败</span>
                        </div>
                    `;
                    
                    showToast('API连接测试失败！', 'error');
                });
        }
        
        // 清空测试结果
        function clearTestResult() {
            const resultContent = document.getElementById('result-content');
            const resultStats = document.getElementById('result-stats');
            
            resultContent.innerHTML = '<p class="empty-message">点击"测试连接"按钮开始测试</p>';
            resultStats.innerHTML = '';
        }
        
        // 获取API配置
        function getApiConfig() {
            return {
                provider: document.querySelector('input[name="api-provider"]:checked').value,
                apiKey: document.getElementById('api-key').value,
                model: document.getElementById('api-model').value,
                apiUrl: document.getElementById('api-url').value,
                temperature: parseFloat(document.getElementById('api-temperature').value),
                maxTokens: parseInt(document.getElementById('api-max-tokens').value),
                enableCache: document.getElementById('enable-cache').checked,
                enableLogging: document.getElementById('enable-logging').checked,
                timeout: parseInt(document.getElementById('api-timeout').value)
            };
        }
        
        // 验证配置
        function validateConfig(config) {
            if (!config.apiKey) {
                showToast('请输入API密钥！', 'error');
                document.getElementById('api-key').focus();
                return false;
            }
            
            if (!config.apiUrl) {
                showToast('请输入API地址！', 'error');
                document.getElementById('api-url').focus();
                return false;
            }
            
            if (!isValidUrl(config.apiUrl)) {
                showToast('API地址格式不正确！', 'error');
                document.getElementById('api-url').focus();
                return false;
            }
            
            if (config.maxTokens < 100 || config.maxTokens > 2000) {
                showToast('最大生成长度应在100-2000之间！', 'error');
                document.getElementById('api-max-tokens').focus();
                return false;
            }
            
            if (config.timeout < 5 || config.timeout > 60) {
                showToast('超时时间应在5-60秒之间！', 'error');
                document.getElementById('api-timeout').focus();
                return false;
            }
            
            return true;
        }
        
        // 检查URL是否有效
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // 保存API配置
        function saveApiConfig() {
            // 获取配置
            const config = getApiConfig();
            
            // 验证配置
            if (!validateConfig(config)) {
                return;
            }
            
            // 保存配置
            localStorage.setItem('api_config', JSON.stringify(config));
            
            showToast('API配置保存成功！', 'success');
        }
        
        // 恢复默认配置
        function resetToDefault() {
            if (confirm('确定要恢复默认配置吗？当前配置将会丢失！')) {
                // 清除本地存储
                localStorage.removeItem('api_config');
                
                // 重置表单
                document.getElementById('provider-deepseek').checked = true;
                document.getElementById('api-key').value = '';
                document.getElementById('api-model').value = 'deepseek-v3.2';
                document.getElementById('api-url').value = 'https://api.deepseek.com/v1/chat/completions';
                document.getElementById('api-temperature').value = '0.7';
                document.getElementById('temperature-value').textContent = '0.7';
                document.getElementById('api-max-tokens').value = '500';
                document.getElementById('enable-cache').checked = true;
                document.getElementById('enable-logging').checked = false;
                document.getElementById('api-timeout').value = '30';
                
                // 清空测试结果
                clearTestResult();
                
                showToast('已恢复默认配置！', 'success');
            }
        }
    </script>
</body>
</html>
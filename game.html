<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏主界面 - 吾家有女初长成</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- 加载动画 -->
    <div id="loading" class="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>正在加载游戏数据...</p>
        </div>
    </div>

    <!-- 游戏主界面 -->
    <div id="game-main" class="game-main hidden">
        <!-- 顶部时间面板 -->
        <div class="time-panel">
            <div class="time-info">
                <div class="time-item">
                    <span class="time-label">年号:</span>
                    <span class="time-value" id="reign-year">乾隆</span>
                </div>
                <div class="time-item">
                    <span class="time-label">年份:</span>
                    <span class="time-value" id="year">元年</span>
                </div>
                <div class="time-item">
                    <span class="time-label">季节:</span>
                    <span class="time-value" id="season">春季</span>
                </div>
                <div class="time-item">
                    <span class="time-label">年龄:</span>
                    <span class="time-value" id="age">12岁</span>
                </div>
            </div>
            <div class="time-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="year-progress" style="width: 0%"></div>
                </div>
                <div class="progress-labels">
                    <span>春季</span>
                    <span>夏季</span>
                    <span>秋季</span>
                    <span>冬季</span>
                </div>
            </div>
        </div>

        <!-- 游戏主内容区 -->
        <div class="game-content">
            <!-- 左侧信息栏 -->
            <div class="left-sidebar">
                <!-- 个人信息 -->
                <div class="info-card">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i> 个人信息
                    </h3>
                    <div class="info-content">
                        <div class="info-group">
                            <label>姓名:</label>
                            <span id="protagonist-name">张昭昭</span>
                        </div>
                        <div class="info-group">
                            <label>排行:</label>
                            <span id="protagonist-rank">三女</span>
                        </div>
                        <div class="info-group">
                            <label>容貌:</label>
                            <div class="attribute-bar">
                                <div class="attribute-fill" id="appearance-bar" style="width: 70%"></div>
                                <span class="attribute-value">70</span>
                            </div>
                        </div>
                        <div class="info-group">
                            <label>性格:</label>
                            <span id="protagonist-personality">温柔体贴</span>
                        </div>
                        <div class="info-group">
                            <label>健康值:</label>
                            <div class="attribute-bar health-bar">
                                <div class="attribute-fill" id="health-bar" style="width: 100%"></div>
                                <span class="attribute-value">100</span>
                            </div>
                        </div>
                        <div class="info-group">
                            <label>情感状态:</label>
                            <div class="attribute-bar emotion-bar">
                                <div class="attribute-fill" id="emotion-bar" style="width: 100%"></div>
                                <span class="attribute-value">100</span>
                            </div>
                        </div>
                        <div class="info-group">
                            <label>资产:</label>
                            <span id="assets-value">100两</span>
                        </div>
                    </div>
                </div>

                <!-- 技能面板 -->
                <div class="skills-card">
                    <h3 class="card-title">
                        <i class="fas fa-book"></i> 技能
                    </h3>
                    <div class="skills-content" id="skills-list">
                        <div class="skill-item">
                            <span class="skill-name">诗词</span>
                            <div class="attribute-bar">
                                <div class="attribute-fill" style="width: 30%"></div>
                                <span class="attribute-value">30</span>
                            </div>
                        </div>
                        <div class="skill-item">
                            <span class="skill-name">女红</span>
                            <div class="attribute-bar">
                                <div class="attribute-fill" style="width: 45%"></div>
                                <span class="attribute-value">45</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-small" onclick="showAllSkills()">查看全部</button>
                    </div>
                </div>
            </div>

            <!-- 中间核心内容区 -->
            <div class="center-content">
                <!-- 内容标签页 -->
                <div class="content-tabs">
                    <button class="content-tab active" data-target="events-tab">年度事件</button>
                    <button class="content-tab" data-target="interaction-tab">人物互动</button>
                    <button class="content-tab" data-target="family-news-tab">家庭动态</button>
                    <button class="content-tab" data-target="diary-tab">我的手记</button>
                </div>

                <!-- 内容区域 -->
                <div class="content-area">
                    <!-- 年度事件 -->
                    <div id="events-tab" class="content-tab-panel active">
                        <div class="events-list" id="yearly-events">
                            <div class="event-item">
                                <div class="event-header">
                                    <h4 class="event-title">
                                        <i class="fas fa-leaf event-icon spring"></i>
                                        春日赏花
                                    </h4>
                                    <span class="event-time">春季</span>
                                </div>
                                <div class="event-content">
                                    <p>春天到了，院子里的桃花开得正艳。父亲提议全家一起去花园赏花，姐妹们都很高兴。你在花园里遇到了一位迷路的少年，他是隔壁府上的公子...</p>
                                </div>
                                <div class="event-choices">
                                    <button class="btn btn-small choice-btn" onclick="makeChoice(1, 'help')">
                                        <i class="fas fa-hand-holding-heart"></i> 主动帮助他
                                    </button>
                                    <button class="btn btn-small choice-btn" onclick="makeChoice(1, 'ignore')">
                                        <i class="fas fa-user-shield"></i> 保持距离
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 人物互动 -->
                    <div id="interaction-tab" class="content-tab-panel">
                        <div class="interaction-list" id="interaction-events">
                            <div class="interaction-item">
                                <div class="interaction-header">
                                    <h4 class="interaction-title">
                                        <i class="fas fa-user-friends"></i>
                                        与二姐的对话
                                    </h4>
                                    <span class="interaction-time">昨日</span>
                                </div>
                                <div class="interaction-content">
                                    <p>二姐昭仪来找你，她最近在学习新的歌舞，想邀请你一起练习...</p>
                                </div>
                                <div class="interaction-choices">
                                    <button class="btn btn-small choice-btn" onclick="makeChoice(2, 'accept')">
                                        <i class="fas fa-check"></i> 欣然接受
                                    </button>
                                    <button class="btn btn-small choice-btn" onclick="makeChoice(2, 'decline')">
                                        <i class="fas fa-times"></i> 婉拒
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 家庭动态 -->
                    <div id="family-news-tab" class="content-tab-panel">
                        <div class="news-paper">
                            <div class="news-header">
                                <h4>张家小报</h4>
                                <span>第1期</span>
                            </div>
                            <div class="news-content" id="family-news">
                                <div class="news-item">
                                    <h5>父亲升迁</h5>
                                    <p>父亲张明远近日被提拔为翰林院侍读，全家上下都很欢喜。</p>
                                </div>
                                <div class="news-item">
                                    <h5>大姐定亲</h5>
                                    <p>大姐昭华与李府公子定亲，婚期定在明年春天。</p>
                                </div>
                                <div class="news-item">
                                    <h5>新丫鬟</h5>
                                    <p>家里新来了一个名叫小翠的丫鬟，聪明伶俐，很讨人喜欢。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 我的手记 -->
                    <div id="diary-tab" class="content-tab-panel">
                        <div class="diary-book">
                            <div class="diary-header">
                                <h4>我的手记</h4>
                                <span id="diary-date">乾隆元年 春季</span>
                            </div>
                            <div class="diary-content" id="diary-content">
                                <p>今天是我12岁的生日，母亲给我做了最喜欢的桂花糕。姐妹们都送了我礼物，大姐送了我一支银簪，二姐教了我一首新诗，四妹画了一幅画给我，五妹给我编了一个草戒指。</p>
                                <p>父亲说我已经长大了，应该开始学习更多的女红和诗词。我很喜欢读书，希望有一天能像父亲一样有学问。</p>
                                <p>晚上，我做了一个奇怪的梦，梦见自己变成了一只蝴蝶，在花园里飞舞...</p>
                            </div>
                            <div class="diary-actions">
                                <button class="btn btn-small" onclick="writeDiary()">
                                    <i class="fas fa-pen"></i> 写日记
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧功能区 -->
            <div class="right-sidebar">
                <!-- 新人物登场 -->
                <div class="character-card">
                    <h3 class="card-title">
                        <i class="fas fa-user-plus"></i> 新人物
                    </h3>
                    <div class="character-content" id="new-character">
                        <div class="character-header">
                            <h4>李明轩</h4>
                            <span class="character-age">15岁</span>
                        </div>
                        <div class="character-info">
                            <p><strong>身份:</strong> 隔壁李府公子</p>
                            <p><strong>性格:</strong> 温文尔雅</p>
                            <p><strong>背景:</strong> 书香门第，父亲是吏部侍郎</p>
                        </div>
                        <div class="character-actions">
                            <button class="btn btn-small" onclick="viewCharacterDetail('李明轩')">
                                <i class="fas fa-search"></i> 查看详情
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 事件记录 -->
                <div class="records-card">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> 事件记录
                    </h3>
                    <div class="records-content" id="event-records">
                        <div class="record-item">
                            <span class="record-time">春季</span>
                            <span class="record-event">初次遇见李明轩</span>
                        </div>
                        <div class="record-item">
                            <span class="record-time">春季</span>
                            <span class="record-event">与二姐一起练习歌舞</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-small" onclick="viewAllRecords()">查看全部</button>
                    </div>
                </div>

                <!-- 书信箱 -->
                <div class="letters-card">
                    <h3 class="card-title">
                        <i class="fas fa-envelope"></i> 书信箱
                    </h3>
                    <div class="letters-content" id="letters-list">
                        <div class="letter-item unread">
                            <span class="letter-sender">大姐</span>
                            <span class="letter-preview">关于定亲的事...</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-small" onclick="viewAllLetters()">查看全部</button>
                    </div>
                </div>

                <!-- 家宅地图 -->
                <div class="map-card">
                    <h3 class="card-title">
                        <i class="fas fa-map"></i> 家宅地图
                    </h3>
                    <div class="map-content" id="home-map">
                        <div class="map-room" data-room="main_hall" onclick="enterRoom('main_hall')">
                            <i class="fas fa-home"></i>
                            <span>正厅</span>
                        </div>
                        <div class="map-room" data-room="bedroom" onclick="enterRoom('bedroom')">
                            <i class="fas fa-bed"></i>
                            <span>闺房</span>
                        </div>
                        <div class="map-room" data-room="garden" onclick="enterRoom('garden')">
                            <i class="fas fa-tree"></i>
                            <span>花园</span>
                        </div>
                        <div class="map-room" data-room="study" onclick="enterRoom('study')">
                            <i class="fas fa-book"></i>
                            <span>书房</span>
                        </div>
                        <div class="map-room" data-room="kitchen" onclick="enterRoom('kitchen')">
                            <i class="fas fa-utensils"></i>
                            <span>厨房</span>
                        </div>
                        <div class="map-room" data-room="ancestral_hall" onclick="enterRoom('ancestral_hall')">
                            <i class="fas fa-church"></i>
                            <span>祠堂</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="bottom-bar">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="nextYear()">
                    <i class="fas fa-forward"></i> 推进下一年
                </button>
                <button class="btn btn-secondary" onclick="viewRelationships()">
                    <i class="fas fa-users"></i> 人物关系
                </button>
                <button class="btn btn-secondary" onclick="viewSkills()">
                    <i class="fas fa-book"></i> 技能资产
                </button>
                <button class="btn btn-secondary" onclick="viewEvents()">
                    <i class="fas fa-calendar-alt"></i> 事件回顾
                </button>
                <button class="btn btn-secondary" onclick="restartGame()">
                    <i class="fas fa-redo"></i> 重开新人生
                </button>
            </div>
            <div class="save-load-buttons">
                <button class="btn btn-save" onclick="showSaveDialog()">
                    <i class="fas fa-save"></i> 存档
                </button>
                <button class="btn btn-load" onclick="showLoadDialog()">
                    <i class="fas fa-folder-open"></i> 读档
                </button>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">模态框标题</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 模态框内容 -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- 模态框底部按钮 -->
            </div>
        </div>
    </div>

    <!-- 提示弹窗 -->
    <div id="toast" class="toast hidden">
        <div class="toast-content">
            <i class="fas fa-check-circle toast-icon success"></i>
            <span class="toast-message">操作成功</span>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="api.js"></script>
    <script src="save-load.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 显示加载动画
            showLoading();
            
            // 尝试加载游戏数据
            setTimeout(function() {
                loadGame(1);
                
                // 如果没有游戏数据，返回主页
                if (!window.gameData) {
                    showToast('没有找到游戏存档！', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                    return;
                }
                
                // 更新界面
                updateGameInterface();
                
                // 隐藏加载动画，显示页面
                hideLoading();
                document.getElementById('game-main').classList.remove('hidden');
                
                // 生成初始事件
                if (window.gameData.events.length === 0) {
                    generateInitialEvents();
                }
            }, 1500);
            
            // 绑定内容标签页切换事件
            const contentTabs = document.querySelectorAll('.content-tab');
            contentTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有标签的active类
                    contentTabs.forEach(t => t.classList.remove('active'));
                    // 添加当前标签的active类
                    this.classList.add('active');
                    
                    // 隐藏所有内容
                    const tabPanels = document.querySelectorAll('.content-tab-panel');
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    
                    // 显示对应内容
                    const targetId = this.getAttribute('data-target');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        });
        
        // 更新游戏界面
        function updateGameInterface() {
            // 更新时间信息
            document.getElementById('reign-year').textContent = window.gameData.family.reignYear;
            document.getElementById('year').textContent = `${window.gameData.time.year}年`;
            document.getElementById('season').textContent = window.gameData.time.season;
            document.getElementById('age').textContent = `${window.gameData.protagonist.age}岁`;
            
            // 更新年份进度
            const seasonIndex = ['春季', '夏季', '秋季', '冬季'].indexOf(window.gameData.time.season);
            document.getElementById('year-progress').style.width = `${(seasonIndex + 1) * 25}%`;
            
            // 更新个人信息
            document.getElementById('protagonist-name').textContent = window.gameData.protagonist.name;
            document.getElementById('protagonist-rank').textContent = window.gameData.protagonist.rank;
            document.getElementById('appearance-bar').style.width = `${window.gameData.protagonist.appearance}%`;
            document.getElementById('appearance-bar').nextElementSibling.textContent = window.gameData.protagonist.appearance;
            document.getElementById('protagonist-personality').textContent = window.gameData.protagonist.personality;
            document.getElementById('health-bar').style.width = `${window.gameData.protagonist.health}%`;
            document.getElementById('health-bar').nextElementSibling.textContent = window.gameData.protagonist.health;
            document.getElementById('emotion-bar').style.width = `${window.gameData.protagonist.emotion}%`;
            document.getElementById('emotion-bar').nextElementSibling.textContent = window.gameData.protagonist.emotion;
            document.getElementById('assets-value').textContent = `${window.gameData.assets.money}两`;
            
            // 更新技能列表
            updateSkillsList();
            
            // 更新年度事件
            updateYearlyEvents();
            
            // 更新人物互动
            updateInteractionEvents();
            
            // 更新家庭动态
            updateFamilyNews();
            
            // 更新日记
            updateDiary();
            
            // 更新事件记录
            updateEventRecords();
            
            // 更新书信
            updateLetters();
        }
        
        // 更新技能列表
        function updateSkillsList() {
            const skillsList = document.getElementById('skills-list');
            skillsList.innerHTML = '';
            
            window.gameData.protagonist.skills.forEach(skill => {
                const skillItem = document.createElement('div');
                skillItem.className = 'skill-item';
                skillItem.innerHTML = `
                    <span class="skill-name">${skill.name}</span>
                    <div class="attribute-bar">
                        <div class="attribute-fill" style="width: ${skill.level}%"></div>
                        <span class="attribute-value">${skill.level}</span>
                    </div>
                `;
                skillsList.appendChild(skillItem);
            });
        }
        
        // 更新年度事件
        function updateYearlyEvents() {
            const eventsList = document.getElementById('yearly-events');
            eventsList.innerHTML = '';
            
            if (window.gameData.yearlyEvents.length === 0) {
                eventsList.innerHTML = '<p class="empty-message">本年内暂无事件</p>';
                return;
            }
            
            window.gameData.yearlyEvents.forEach((event, index) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                
                // 根据季节选择图标
                const seasonIcons = {
                    '春季': '<i class="fas fa-leaf event-icon spring"></i>',
                    '夏季': '<i class="fas fa-sun event-icon summer"></i>',
                    '秋季': '<i class="fas fa-tree event-icon autumn"></i>',
                    '冬季': '<i class="fas fa-snowflake event-icon winter"></i>'
                };
                
                eventItem.innerHTML = `
                    <div class="event-header">
                        <h4 class="event-title">
                            ${seasonIcons[event.season] || '<i class="fas fa-calendar event-icon"></i>'}
                            ${event.title}
                        </h4>
                        <span class="event-time">${event.season}</span>
                    </div>
                    <div class="event-content">
                        <p>${event.description}</p>
                    </div>
                `;
                
                // 如果事件有选择项且未选择
                if (event.choices && !event.chosen) {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.className = 'event-choices';
                    
                    event.choices.forEach((choice, choiceIndex) => {
                        const choiceBtn = document.createElement('button');
                        choiceBtn.className = 'btn btn-small choice-btn';
                        choiceBtn.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
                        choiceBtn.onclick = () => makeChoice(index, choiceIndex);
                        choicesDiv.appendChild(choiceBtn);
                    });
                    
                    eventItem.appendChild(choicesDiv);
                }
                // 如果事件已选择
                else if (event.chosen) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'event-result';
                    resultDiv.innerHTML = `
                        <p><strong>你的选择:</strong> ${event.choices[event.chosen].text}</p>
                        <p>${event.result}</p>
                    `;
                    eventItem.appendChild(resultDiv);
                }
                
                eventsList.appendChild(eventItem);
            });
        }
        
        // 更新人物互动
        function updateInteractionEvents() {
            const interactionList = document.getElementById('interaction-events');
            interactionList.innerHTML = '';
            
            // 获取最近的5个互动事件
            const recentInteractions = window.gameData.events
                .filter(event => event.type === 'interaction')
                .slice(-5)
                .reverse();
            
            if (recentInteractions.length === 0) {
                interactionList.innerHTML = '<p class="empty-message">暂无互动事件</p>';
                return;
            }
            
            recentInteractions.forEach((event, index) => {
                const interactionItem = document.createElement('div');
                interactionItem.className = 'interaction-item';
                
                interactionItem.innerHTML = `
                    <div class="interaction-header">
                        <h4 class="interaction-title">
                            <i class="fas fa-user-friends"></i>
                            与${event.target}的互动
                        </h4>
                        <span class="interaction-time">${getRelativeTime(event.time)}</span>
                    </div>
                    <div class="interaction-content">
                        <p>${event.description}</p>
                    </div>
                `;
                
                // 如果互动有选择项且未选择
                if (event.choices && !event.chosen) {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.className = 'interaction-choices';
                    
                    event.choices.forEach((choice, choiceIndex) => {
                        const choiceBtn = document.createElement('button');
                        choiceBtn.className = 'btn btn-small choice-btn';
                        choiceBtn.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
                        choiceBtn.onclick = () => makeInteractionChoice(event.id, choiceIndex);
                        choicesDiv.appendChild(choiceBtn);
                    });
                    
                    interactionItem.appendChild(choicesDiv);
                }
                // 如果互动已选择
                else if (event.chosen) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'interaction-result';
                    resultDiv.innerHTML = `
                        <p><strong>你的选择:</strong> ${event.choices[event.chosen].text}</p>
                        <p>${event.result}</p>
                    `;
                    interactionItem.appendChild(resultDiv);
                }
                
                interactionList.appendChild(interactionItem);
            });
        }
        
        // 更新家庭动态
        function updateFamilyNews() {
            const newsContent = document.getElementById('family-news');
            newsContent.innerHTML = '';
            
            if (window.gameData.familyNews.length === 0) {
                newsContent.innerHTML = '<p class="empty-message">暂无家庭动态</p>';
                return;
            }
            
            window.gameData.familyNews.slice(-3).forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                newsItem.innerHTML = `
                    <h5>${news.title}</h5>
                    <p>${news.content}</p>
                `;
                
                newsContent.appendChild(newsItem);
            });
        }
        
        // 更新日记
        function updateDiary() {
            const diaryDate = document.getElementById('diary-date');
            const diaryContent = document.getElementById('diary-content');
            
            // 更新日期
            diaryDate.textContent = `${window.gameData.family.reignYear}${window.gameData.time.year}年 ${window.gameData.time.season}`;
            
            // 获取当前季节的日记
            const currentDiary = window.gameData.events.find(
                event => event.type === 'diary' && 
                event.year === window.gameData.time.year && 
                event.season === window.gameData.time.season
            );
            
            if (currentDiary) {
                diaryContent.innerHTML = currentDiary.content.replace(/\n/g, '<p>');
            } else {
                diaryContent.innerHTML = '<p>这个季节还没有写日记，点击"写日记"按钮记录你的心情吧！</p>';
            }
        }
        
        // 更新事件记录
        function updateEventRecords() {
            const eventRecords = document.getElementById('event-records');
            eventRecords.innerHTML = '';
            
            if (window.gameData.events.length === 0) {
                eventRecords.innerHTML = '<p class="empty-message">暂无事件记录</p>';
                return;
            }
            
            // 获取最近的5个事件
            const recentEvents = window.gameData.events.slice(-5).reverse();
            
            recentEvents.forEach(event => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                let eventType = '';
                switch (event.type) {
                    case 'yearly':
                        eventType = '年度事件';
                        break;
                    case 'interaction':
                        eventType = `与${event.target}互动`;
                        break;
                    case 'diary':
                        eventType = '写日记';
                        break;
                    default:
                        eventType = event.title || '事件';
                }
                
                recordItem.innerHTML = `
                    <span class="record-time">${event.season}</span>
                    <span class="record-event">${eventType}</span>
                `;
                
                eventRecords.appendChild(recordItem);
            });
        }
        
        // 更新书信
        function updateLetters() {
            const lettersList = document.getElementById('letters-list');
            lettersList.innerHTML = '';
            
            if (window.gameData.letters.length === 0) {
                lettersList.innerHTML = '<p class="empty-message">暂无书信</p>';
                return;
            }
            
            // 获取未读书信
            const unreadLetters = window.gameData.letters.filter(letter => !letter.read);
            
            if (unreadLetters.length === 0) {
                lettersList.innerHTML = '<p class="empty-message">暂无未读书信</p>';
                return;
            }
            
            unreadLetters.slice(0, 3).forEach(letter => {
                const letterItem = document.createElement('div');
                letterItem.className = 'letter-item unread';
                letterItem.innerHTML = `
                    <span class="letter-sender">${letter.sender}</span>
                    <span class="letter-preview">${letter.preview}</span>
                `;
                letterItem.onclick = () => readLetter(letter.id);
                
                lettersList.appendChild(letterItem);
            });
        }
        
        // 生成初始事件
        function generateInitialEvents() {
            // 生成春季事件
            generateSeasonalEvents('春季');
            
            // 生成家庭动态
            generateFamilyNews();
            
            // 保存游戏
            saveGame(1);
        }
        
        // 生成季节性事件
        function generateSeasonalEvents(season) {
            // 春季事件列表
            const springEvents = [
                {
                    title: '春日赏花',
                    description: '春天到了，院子里的桃花开得正艳。父亲提议全家一起去花园赏花，姐妹们都很高兴。你在花园里遇到了一位迷路的少年，他是隔壁府上的公子...',
                    choices: [
                        { text: '主动帮助他', icon: 'hand-holding-heart', effect: { wisdom: 5, social: 5 } },
                        { text: '保持距离', icon: 'user-shield', effect: { wisdom: 2 } }
                    ]
                },
                {
                    title: '春日诗会',
                    description: '清明节前夕，城里举办了一场春日诗会，许多文人墨客都会参加。父亲问你是否愿意一同前往...',
                    choices: [
                        { text: '欣然前往', icon: 'check', effect: { poetry: 10, social: 5 } },
                        { text: '婉拒', icon: 'times', effect: { embroidery: 5 } }
                    ]
                },
                {
                    title: '养蚕季节',
                    description: '到了养蚕的季节，母亲和姐妹们都开始准备养蚕。你以前从未养过蚕，母亲问你是否愿意尝试...',
                    choices: [
                        { text: '尝试养蚕', icon: 'bug', effect: { embroidery: 8, patience: 5 } },
                        { text: '帮忙准备桑叶', icon: 'leaf', effect: { cooking: 5, health: 5 } }
                    ]
                }
            ];
            
            // 夏季事件列表
            const summerEvents = [
                {
                    title: '夏日荷宴',
                    description: '夏日炎炎，荷花盛开。母亲准备举办一场荷宴，邀请亲朋好友前来赏荷。她希望你能帮忙准备...',
                    choices: [
                        { text: '帮忙布置场地', icon: 'flower', effect: { social: 8, decoration: 5 } },
                        { text: '帮忙准备食物', icon: 'utensils', effect: { cooking: 8, health: 3 } }
                    ]
                },
                {
                    title: '避暑山庄',
                    description: '天气越来越热，父亲决定带全家去避暑山庄小住一段时间。这是你第一次去避暑山庄...',
                    choices: [
                        { text: '在山庄里读书', icon: 'book', effect: { wisdom: 10, poetry: 5 } },
                        { text: '在山庄里游玩', icon: 'tree', effect: { health: 10, social: 5 } }
                    ]
                },
                {
                    title: '七夕节',
                    description: '七夕节到了，姐妹们都在准备乞巧。你也想参加，但不知道该准备什么...',
                    choices: [
                        { text: '准备女红作品', icon: 'needle', effect: { embroidery: 10, luck: 5 } },
                        { text: '准备诗词作品', icon: 'pen', effect: { poetry: 10, wisdom: 5 } }
                    ]
                }
            ];
            
            // 秋季事件列表
            const autumnEvents = [
                {
                    title: '中秋赏月',
                    description: '中秋节到了，全家一起赏月吃月饼。父亲提议每人作一首中秋诗...',
                    choices: [
                        { text: '即兴作诗', icon: 'pen', effect: { poetry: 10, family: 5 } },
                        { text: '分享月饼', icon: 'cookie', effect: { cooking: 5, family: 10 } }
                    ]
                },
                {
                    title: '菊花展',
                    description: '城里举办了一场菊花展，展出了各种各样的菊花。母亲问你是否想去看看...',
                    choices: [
                        { text: '欣然前往', icon: 'check', effect: { painting: 8, social: 5 } },
                        { text: '在家学习', icon: 'book', effect: { wisdom: 8, embroidery: 5 } }
                    ]
                },
                {
                    title: '收获季节',
                    description: '秋天是收获的季节，家里的果园丰收了。父亲让你们姐妹帮忙采摘水果...',
                    choices: [
                        { text: '帮忙采摘', icon: 'apple-alt', effect: { health: 8, cooking: 5 } },
                        { text: '帮忙制作果酱', icon: 'jar', effect: { cooking: 10, patience: 5 } }
                    ]
                }
            ];
            
            // 冬季事件列表
            const winterEvents = [
                {
                    title: '冬至饺子',
                    description: '冬至到了，母亲教你们姐妹包饺子。这是你第一次学包饺子...',
                    choices: [
                        { text: '认真学习', icon: 'utensils', effect: { cooking: 10, patience: 5 } },
                        { text: '帮忙准备馅料', icon: 'carrot', effect: { cooking: 5, health: 5 } }
                    ]
                },
                {
                    title: '腊八节',
                    description: '腊八节到了，母亲准备熬腊八粥。她让你们姐妹各自准备一些食材...',
                    choices: [
                        { text: '准备红豆', icon: 'seedling', effect: { cooking: 5, luck: 5 } },
                        { text: '准备糯米', icon: 'grain', effect: { cooking: 5, health: 5 } }
                    ]
                },
                {
                    title: '新年准备',
                    description: '快过年了，家里忙着准备年货。母亲让你们姐妹帮忙打扫房间...',
                    choices: [
                        { text: '认真打扫', icon: 'broom', effect: { patience: 8, family: 5 } },
                        { text: '帮忙贴春联', icon: 'scroll', effect: { poetry: 8, calligraphy: 5 } }
                    ]
                }
            ];
            
            // 根据季节选择事件
            let events;
            switch (season) {
                case '春季':
                    events = springEvents;
                    break;
                case '夏季':
                    events = summerEvents;
                    break;
                case '秋季':
                    events = autumnEvents;
                    break;
                case '冬季':
                    events = winterEvents;
                    break;
                default:
                    events = springEvents;
            }
            
            // 随机选择2-3个事件
            const eventCount = Math.floor(Math.random() * 2) + 2; // 2-3个事件
            const selectedEvents = [];
            
            while (selectedEvents.length < eventCount && events.length > 0) {
                const randomIndex = Math.floor(Math.random() * events.length);
                const event = events[randomIndex];
                
                // 添加事件ID和时间
                event.id = Date.now() + selectedEvents.length;
                event.time = Date.now();
                event.year = window.gameData.time.year;
                event.season = season;
                event.type = 'yearly';
                event.chosen = null;
                
                selectedEvents.push(event);
                events.splice(randomIndex, 1);
            }
            
            // 添加到年度事件
            window.gameData.yearlyEvents = selectedEvents;
            
            // 添加到事件记录
            window.gameData.events.push(...selectedEvents);
            
            // 更新界面
            updateYearlyEvents();
            updateEventRecords();
        }
        
        // 生成家庭动态
        function generateFamilyNews() {
            // 家庭动态列表
            const newsList = [
                {
                    title: '父亲升迁',
                    content: '父亲张明远近日被提拔为翰林院侍读，全家上下都很欢喜。'
                },
                {
                    title: '大姐定亲',
                    content: '大姐昭华与李府公子定亲，婚期定在明年春天。'
                },
                {
                    title: '新丫鬟',
                    content: '家里新来了一个名叫小翠的丫鬟，聪明伶俐，很讨人喜欢。'
                },
                {
                    title: '母亲生病',
                    content: '母亲近日偶感风寒，需要卧床休息几天。姐妹们都轮流照顾她。'
                },
                {
                    title: '五妹入学',
                    content: '五妹昭惠到了入学的年龄，父亲决定请一位先生来家里教她读书。'
                }
            ];
            
            // 随机选择1-2条动态
            const newsCount = Math.floor(Math.random() * 2) + 1; // 1-2条动态
            const selectedNews = [];
            
            while (selectedNews.length < newsCount && newsList.length > 0) {
                const randomIndex = Math.floor(Math.random() * newsList.length);
                const news = newsList[randomIndex];
                
                // 添加新闻ID和时间
                news.id = Date.now() + selectedNews.length;
                news.time = Date.now();
                news.year = window.gameData.time.year;
                news.season = window.gameData.time.season;
                
                selectedNews.push(news);
                newsList.splice(randomIndex, 1);
            }
            
            // 添加到家庭动态
            window.gameData.familyNews.push(...selectedNews);
            
            // 更新界面
            updateFamilyNews();
        }
        
        // 做出选择
        function makeChoice(eventIndex, choiceIndex) {
            const event = window.gameData.yearlyEvents[eventIndex];
            if (!event || event.chosen !== null) return;
            
            // 记录选择
            event.chosen = choiceIndex;
            
            // 生成结果
            const choice = event.choices[choiceIndex];
            event.result = generateEventResult(event, choice);
            
            // 应用效果
            applyEventEffects(choice.effect);
            
            // 更新界面
            updateYearlyEvents();
            updateEventRecords();
            
            // 显示提示
            showToast(`你选择了"${choice.text}"`, 'success');
            
            // 保存游戏
            saveGame(1);
        }
        
        // 生成事件结果
        function generateEventResult(event, choice) {
            // 根据事件和选择生成结果
            const results = {
                '春日赏花': {
                    0: '你主动帮助了那位少年，他叫李明轩，是隔壁李府的公子。他对你的帮助表示感谢，并邀请你有机会去他家的花园赏花。这次相遇让你学会了如何与陌生人友好相处。',
                    1: '你保持了适当的距离，礼貌地指引他找到了出路。虽然没有深入交流，但你的谨慎态度得到了父亲的赞赏。'
                },
                '春日诗会': {
                    0: '你跟着父亲参加了诗会，结识了许多文人墨客，听他们讨论诗词，受益匪浅。一位老先生还称赞了你的诗词天赋。',
                    1: '你婉拒了父亲的邀请，在家中练习女红。母亲对你的懂事表示赞赏，并教了你几个新的刺绣技巧。'
                },
                '养蚕季节': {
                    0: '你开始尝试养蚕，虽然一开始有些手忙脚乱，但在母亲的指导下，你逐渐掌握了养蚕的技巧。看着蚕宝宝一天天长大，你感到很有成就感。',
                    1: '你选择帮忙准备桑叶，每天早起去采摘新鲜的桑叶。这个过程让你更加了解植物，也锻炼了身体。'
                },
                '夏日荷宴': {
                    0: '你帮忙布置场地，用荷花和荷叶装饰了整个院子。客人们都对你的布置赞不绝口，母亲也为你感到骄傲。',
                    1: '你帮忙准备食物，学会了几道以荷花为主题的菜肴。客人们对你做的荷花糕赞不绝口。'
                },
                '避暑山庄': {
                    0: '你在山庄里读了很多书，特别是一些诗词集，让你的诗词水平有了很大的提高。父亲也经常和你讨论书中的内容。',
                    1: '你在山庄里尽情游玩，爬山、游泳、采摘野果，身体变得更加健康。你还结识了一些新朋友。'
                },
                '七夕节': {
                    0: '你准备了一件精美的女红作品，在乞巧节上得到了大家的赞赏。据说这会给你带来好运。',
                    1: '你准备了一首关于七夕的诗词，在乞巧节上朗诵给大家听。父亲对你的才华赞不绝口。'
                },
                '中秋赏月': {
                    0: '你即兴作了一首中秋诗，大家都对你的才华感到惊讶。父亲更是当众夸奖了你。',
                    1: '你分享了自己做的月饼，大家都很喜欢。这个中秋节让你感受到了家庭的温暖。'
                },
                '菊花展': {
                    0: '你去了菊花展，看到了各种各样的菊花，对你的绘画很有启发。你还结识了一位同样喜欢绘画的小姐。',
                    1: '你选择在家学习，读了很多书，还练习了女红。母亲对你的勤奋表示赞赏。'
                },
                '收获季节': {
                    0: '你帮忙采摘水果，虽然很累，但看到满筐的水果，你感到很有成就感。你还学会了如何挑选成熟的水果。',
                    1: '你帮忙制作果酱，学会了几种不同果酱的做法。家人都很喜欢你做的果酱。'
                },
                '冬至饺子': {
                    0: '你认真学习包饺子，虽然一开始包得不太好，但在母亲的指导下，你逐渐掌握了技巧。吃着自己包的饺子，你感到特别满足。',
                    1: '你帮忙准备馅料，学会了如何搭配不同的食材。母亲说你准备的馅料特别香。'
                },
                '腊八节': {
                    0: '你准备了红豆，母亲说红豆象征着吉祥。腊八粥煮好后，大家都说特别好喝。',
                    1: '你准备了糯米，母亲说糯米是腊八粥的重要成分。腊八粥煮好后，大家都说特别香。'
                },
                '新年准备': {
                    0: '你认真打扫房间，把每个角落都打扫得干干净净。母亲对你的细心表示赞赏。',
                    1: '你帮忙贴春联，父亲教了你一些关于春联的知识。你的书法也有了一些进步。'
                }
            };
            
            // 如果有预设结果，返回预设结果
            if (results[event.title] && results[event.title][choiceIndex]) {
                return results[event.title][choiceIndex];
            }
            
            // 否则生成通用结果
            return `你选择了"${choice.text}"，这个选择让你学到了很多东西，也让你对自己有了更深的了解。`;
        }
        
        // 应用事件效果
        function applyEffects(effects) {
            if (!effects) return;
            
            // 应用技能效果
            for (const [skill, value] of Object.entries(effects)) {
                // 查找技能
                const skillIndex = window.gameData.protagonist.skills.findIndex(s => s.name === skill);
                
                if (skillIndex !== -1) {
                    // 更新技能等级
                    window.gameData.protagonist.skills[skillIndex].level = Math.min(100, window.gameData.protagonist.skills[skillIndex].level + value);
                } else {
                    // 添加新技能
                    window.gameData.protagonist.skills.push({
                        name: skill,
                        level: value
                    });
                }
            }
            
            // 更新界面
            updateSkillsList();
        }
        
        // 应用事件效果
        function applyEventEffects(effects) {
            if (!effects) return;
            
            // 应用健康和情感效果
            if (effects.health) {
                window.gameData.protagonist.health = Math.min(100, Math.max(0, window.gameData.protagonist.health + effects.health));
            }
            
            if (effects.emotion) {
                window.gameData.protagonist.emotion = Math.min(100, Math.max(0, window.gameData.protagonist.emotion + effects.emotion));
            }
            
            // 应用技能效果
            for (const [skill, value] of Object.entries(effects)) {
                if (skill === 'health' || skill === 'emotion') continue;
                
                // 查找技能
                const skillIndex = window.gameData.protagonist.skills.findIndex(s => s.name === skill);
                
                if (skillIndex !== -1) {
                    // 更新技能等级
                    window.gameData.protagonist.skills[skillIndex].level = Math.min(100, window.gameData.protagonist.skills[skillIndex].level + value);
                } else {
                    // 添加新技能
                    window.gameData.protagonist.skills.push({
                        name: skill,
                        level: value
                    });
                }
            }
            
            // 更新界面
            updateGameInterface();
        }
        
        // 推进到下一年
        function nextYear() {
            showToast('正在推进到下一年...', 'info');
            
            setTimeout(() => {
                // 检查是否所有年度事件都已处理
                const unprocessedEvents = window.gameData.yearlyEvents.filter(event => event.chosen === null);
                if (unprocessedEvents.length > 0) {
                    showToast('请先处理完所有年度事件！', 'error');
                    return;
                }
                
                // 更新时间
                const seasons = ['春季', '夏季', '秋季', '冬季'];
                const currentSeasonIndex = seasons.indexOf(window.gameData.time.season);
                
                if (currentSeasonIndex === 3) {
                    // 如果是冬季，推进到下一年的春季
                    window.gameData.time.year++;
                    window.gameData.time.season = '春季';
                    window.gameData.protagonist.age++;
                    
                    // 检查是否达到结局条件
                    if (window.gameData.protagonist.age >= 50) {
                        showToast('你的人生已经走到了尽头...', 'info');
                        setTimeout(() => {
                            generateEnding();
                        }, 1000);
                        return;
                    }
                } else {
                    // 否则推进到下一个季节
                    window.gameData.time.season = seasons[currentSeasonIndex + 1];
                }
                
                // 生成新的季节性事件
                generateSeasonalEvents(window.gameData.time.season);
                
                // 随机生成家庭动态
                if (Math.random() > 0.5) {
                    generateFamilyNews();
                }
                
                // 随机生成人物互动
                if (Math.random() > 0.3) {
                    generateRandomInteraction();
                }
                
                // 随机生成书信
                if (Math.random() > 0.7) {
                    generateRandomLetter();
                }
                
                // 更新年龄相关状态
                updateAgeRelatedStatus();
                
                // 更新界面
                updateGameInterface();
                
                // 保存游戏
                saveGame(1);
                
                showToast(`已推进到${window.gameData.time.season}！`, 'success');
            }, 500);
        }
        
        // 生成随机互动
        function generateRandomInteraction() {
            // 可能的互动对象
            const possibleTargets = [];
            
            // 添加姐妹
            window.gameData.sisters.forEach(sister => {
                possibleTargets.push({
                    name: sister.name,
                    type: 'sister',
                    personality: sister.personality
                });
            });
            
            // 添加父母
            window.gameData.parents.forEach(parent => {
                possibleTargets.push({
                    name: parent.name,
                    type: 'parent',
                    personality: parent.personality
                });
            });
            
            // 随机选择一个互动对象
            const target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
            
            // 根据对象类型生成互动
            let interaction;
            
            if (target.type === 'sister') {
                interaction = generateSisterInteraction(target);
            } else if (target.type === 'parent') {
                interaction = generateParentInteraction(target);
            }
            
            // 添加互动ID和时间
            interaction.id = Date.now();
            interaction.time = Date.now();
            interaction.year = window.gameData.time.year;
            interaction.season = window.gameData.time.season;
            interaction.type = 'interaction';
            interaction.target = target.name;
            interaction.chosen = null;
            
            // 添加到事件记录
            window.gameData.events.push(interaction);
            
            // 更新界面
            updateInteractionEvents();
            updateEventRecords();
            
            return interaction;
        }
        
        // 生成姐妹互动
        function generateSisterInteraction(sister) {
            // 姐妹互动列表
            const interactions = [
                {
                    title: '姐妹聊天',
                    description: `${sister.name}来找你聊天，她最近有一些心事想和你分享...`,
                    choices: [
                        { text: '认真倾听', icon: 'ear', effect: { emotion: 5, family: 10 } },
                        { text: '给出建议', icon: 'lightbulb', effect: { wisdom: 5, family: 5 } }
                    ]
                },
                {
                    title: '一起学习',
                    description: `${sister.name}邀请你一起学习，她最近在学习一首新诗...`,
                    choices: [
                        { text: '欣然接受', icon: 'book', effect: { poetry: 8, family: 5 } },
                        { text: '建议学习其他', icon: 'exchange-alt', effect: { wisdom: 5, family: 3 } }
                    ]
                },
                {
                    title: '一起逛街',
                    description: `${sister.name}想和你一起去逛街，她说最近市面上有很多新奇的东西...`,
                    choices: [
                        { text: '欣然前往', icon: 'shopping-bag', effect: { social: 8, money: -10 } },
                        { text: '建议在家', icon: 'home', effect: { embroidery: 5, family: 3 } }
                    ]
                }
            ];
            
            // 随机选择一个互动
            return interactions[Math.floor(Math.random() * interactions.length)];
        }
        
        // 生成父母互动
        function generateParentInteraction(parent) {
            // 父母互动列表
            const fatherInteractions = [
                {
                    title: '父亲的教导',
                    description: '父亲叫你到书房，他想教你一些为人处世的道理...',
                    choices: [
                        { text: '认真聆听', icon: 'ear', effect: { wisdom: 10, family: 5 } },
                        { text: '提出疑问', icon: 'question-circle', effect: { wisdom: 5, courage: 5 } }
                    ]
                },
                {
                    title: '一起读书',
                    description: '父亲邀请你一起读书，他最近在看一本很有趣的书...',
                    choices: [
                        { text: '欣然接受', icon: 'book', effect: { wisdom: 8, family: 5 } },
                        { text: '分享自己的书', icon: 'exchange-alt', effect: { wisdom: 5, family: 8 } }
                    ]
                }
            ];
            
            const motherInteractions = [
                {
                    title: '母亲的教导',
                    description: '母亲叫你到厨房，她想教你一些女红技巧...',
                    choices: [
                        { text: '认真学习', icon: 'needle', effect: { embroidery: 10, family: 5 } },
                        { text: '分享自己的想法', icon: 'lightbulb', effect: { embroidery: 5, creativity: 5 } }
                    ]
                },
                {
                    title: '一起做饭',
                    description: '母亲邀请你一起做饭，她说想教你一道新菜...',
                    choices: [
                        { text: '欣然接受', icon: 'utensils', effect: { cooking: 10, family: 5 } },
                        { text: '建议做其他', icon: 'exchange-alt', effect: { cooking: 5, creativity: 5 } }
                    ]
                }
            ];
            
            // 根据父母类型选择互动
            if (parent.name.includes('父亲')) {
                return fatherInteractions[Math.floor(Math.random() * fatherInteractions.length)];
            } else {
                return motherInteractions[Math.floor(Math.random() * motherInteractions.length)];
            }
        }
        
        // 生成随机书信
        function generateRandomLetter() {
            // 可能的寄信人
            const possibleSenders = [];
            
            // 添加姐妹（如果已出嫁）
            window.gameData.sisters.forEach(sister => {
                if (sister.married) {
                    possibleSenders.push({
                        name: sister.name,
                        type: 'sister',
                        relationship: sister.relationship
                    });
                }
            });
            
            // 添加其他可能的寄信人
            possibleSenders.push(
                { name: '外祖母', type: 'relative', relationship: '亲近' },
                { name: '表兄', type: 'cousin', relationship: '一般' },
                { name: '昔日好友', type: 'friend', relationship: '友好' }
            );
            
            // 随机选择一个寄信人
            const sender = possibleSenders[Math.floor(Math.random() * possibleSenders.length)];
            
            // 根据寄信人类型生成书信
            let letter;
            
            if (sender.type === 'sister') {
                letter = generateSisterLetter(sender);
            } else if (sender.type === 'relative') {
                letter = generateRelativeLetter(sender);
            } else if (sender.type === 'friend') {
                letter = generateFriendLetter(sender);
            }
            
            // 添加书信ID和时间
            letter.id = Date.now();
            letter.time = Date.now();
            letter.year = window.gameData.time.year;
            letter.season = window.gameData.time.season;
            letter.read = false;
            
            // 添加到书信列表
            window.gameData.letters.push(letter);
            
            // 更新界面
            updateLetters();
            
            return letter;
        }
        
        // 生成姐妹书信
        function generateSisterLetter(sister) {
            // 姐妹书信列表
            const letters = [
                {
                    sender: sister.name,
                    title: '近况问候',
                    content: `妹妹安好：

自出嫁以来，已有数月未见，甚是想念。我在夫家一切安好，公婆待我甚好，夫君也很体贴。近日天气转凉，妹妹要注意保暖。

听说父亲近日升迁，真是可喜可贺。待明年春天，我定当回娘家好好庆贺。

妹妹若是有空，不妨写信与我分享近况，我很想知道你最近在忙些什么。

顺颂时祺
姐姐手书`,
                    preview: '自出嫁以来，已有数月未见，甚是想念...'
                },
                {
                    sender: sister.name,
                    title: '邀请回门',
                    content: `妹妹安好：

下个月是我的回门之日，我特意写信邀请你一同前来。我准备了一些你喜欢的东西，还有一些女红技巧想与你分享。

夫家最近新得了一些上好的绸缎，我已让人给你留了一匹，颜色是你最喜欢的月白色。

期待与你相见。

顺颂时祺
姐姐手书`,
                    preview: '下个月是我的回门之日，我特意写信邀请你一同前来...'
                }
            ];
            
            // 随机选择一封书信
            return letters[Math.floor(Math.random() * letters.length)];
        }
        
        // 生成亲戚书信
        function generateRelativeLetter(relative) {
            // 亲戚书信列表
            const letters = [
                {
                    sender: relative.name,
                    title: '问候近况',
                    content: `昭昭安好：

许久未见，甚是想念。听说你最近在学习诗词，外祖母很是欣慰。我年轻时也很喜欢诗词，只可惜后来家务繁忙，便很少有时间研习了。

近日天气转凉，我让人做了几件冬衣，已经让人给你送过去了。料子是上好的绸缎，穿着应该很暖和。

有时间的话，让你母亲带你来看我，我很想你。

顺颂时祺
外祖母手书`,
                    preview: '许久未见，甚是想念。听说你最近在学习诗词...'
                }
            ];
            
            // 随机选择一封书信
            return letters[Math.floor(Math.random() * letters.length)];
        }
        
        // 生成朋友书信
        function generateFriendLetter(friend) {
            // 朋友书信列表
            const letters = [
                {
                    sender: friend.name,
                    title: '邀请聚会',
                    content: `昭昭：

近日可好？我最近听说城里新开了一家书斋，里面有很多新奇的书籍，我想邀请你一起去看看。

记得我们以前经常一起逛街、买书，那段时光真是令人怀念。如果你有空，我们可以约个时间，再像以前一样好好逛逛。

期待你的回复。

友：小蝶`,
                    preview: '近日可好？我最近听说城里新开了一家书斋...'
                }
            ];
            
            // 随机选择一封书信
            return letters[Math.floor(Math.random() * letters.length)];
        }
        
        // 更新年龄相关状态
        function updateAgeRelatedStatus() {
            const age = window.gameData.protagonist.age;
            
            // 15-18岁：开始有媒人上门说亲
            if (age >= 15 && age < 18 && !window.gameData.hasMatchmaker) {
                window.gameData.hasMatchmaker = true;
                const matchmakerEvent = {
                    id: Date.now(),
                    time: Date.now(),
                    year: window.gameData.time.year,
                    season: window.gameData.time.season,
                    type: 'yearly',
                    title: '媒人上门',
                    description: '近日，有媒人上门为你说亲。对方是城里一位富商的儿子，家境殷实，但你从未见过他...',
                    choices: [
                        { text: '考虑这门亲事', icon: 'heart', effect: { family: 5, money: 50 } },
                        { text: '婉拒媒人', icon: 'times', effect: { wisdom: 5, courage: 5 } }
                    ],
                    chosen: null
                };
                
                window.gameData.yearlyEvents.push(matchmakerEvent);
                window.gameData.events.push(matchmakerEvent);
                
                // 更新界面
                updateYearlyEvents();
                updateEventRecords();
            }
            
            // 18-20岁：如果还未出嫁，会有更多媒人上门
            if (age >= 18 && age < 20 && !window.gameData.married && !window.gameData.hasMultipleMatchmakers) {
                window.gameData.hasMultipleMatchmakers = true;
                const multipleMatchmakersEvent = {
                    id: Date.now(),
                    time: Date.now(),
                    year: window.gameData.time.year,
                    season: window.gameData.time.season,
                    type: 'yearly',
                    title: '多家媒人',
                    description: '近日，有多家媒人上门为你说亲。有官员之子、富商之子、甚至还有一位举人...',
                    choices: [
                        { text: '选择官员之子', icon: 'landmark', effect: { social: 10, family: 5 } },
                        { text: '选择富商之子', icon: 'coins', effect: { money: 100, social: 5 } },
                        { text: '选择举人', icon: 'book', effect: { wisdom: 10, family: 3 } },
                        { text: '再等等', icon: 'clock', effect: { wisdom: 5, courage: 10 } }
                    ],
                    chosen: null
                };
                
                window.gameData.yearlyEvents.push(multipleMatchmakersEvent);
                window.gameData.events.push(multipleMatchmakersEvent);
                
                // 更新界面
                updateYearlyEvents();
                updateEventRecords();
            }
            
            // 25岁以上：如果还未出嫁，会有社会压力
            if (age >= 25 && !window.gameData.married && !window.gameData.hasSocialPressure) {
                window.gameData.hasSocialPressure = true;
                const socialPressureEvent = {
                    id: Date.now(),
                    time: Date.now(),
                    year: window.gameData.time.year,
                    season: window.gameData.time.season,
                    type: 'yearly',
                    title: '社会压力',
                    description: '随着年龄的增长，你开始感受到来自社会的压力。邻里间的闲言碎语，父母的担忧，都让你感到有些困扰...',
                    choices: [
                        { text: '妥协出嫁', icon: 'heart-broken', effect: { emotion: -10, family: 5 } },
                        { text: '坚持自己的选择', icon: 'shield-alt', effect: { courage: 15, emotion: -5 } }
                    ],
                    chosen: null
                };
                
                window.gameData.yearlyEvents.push(socialPressureEvent);
                window.gameData.events.push(socialPressureEvent);
                
                // 更新界面
                updateYearlyEvents();
                updateEventRecords();
            }
            
            // 30岁以上：健康开始下降
            if (age >= 30) {
                window.gameData.protagonist.health = Math.max(50, window.gameData.protagonist.health - 2);
            }
            
            // 40岁以上：健康和情感开始明显下降
            if (age >= 40) {
                window.gameData.protagonist.health = Math.max(30, window.gameData.protagonist.health - 3);
                window.gameData.protagonist.emotion = Math.max(50, window.gameData.protagonist.emotion - 2);
            }
        }
        
        // 生成结局
        function generateEnding() {
            // 计算寿命（50-90岁）
            const lifespan = Math.floor(Math.random() * 41) + 50;
            window.gameData.protagonist.age = lifespan;
            
            // 根据游戏数据生成结局
            const ending = {
                title: generateEndingTitle(),
                content: generateAutobiography(),
                familyFuture: generateFamilyFuture(),
                date: `${window.gameData.family.reignYear}${window.gameData.time.year}年`,
                age: lifespan
            };
            
            // 保存结局
            window.gameData.ending = ending;
            
            // 显示结局
            showEndingModal(ending);
        }
        
        // 生成结局标题
        function generateEndingTitle() {
            // 根据主角的主要经历生成标题
            const titles = [
                '平凡而幸福的一生',
                '书香门第的才女',
                '贤妻良母的典范',
                '独立自主的女性',
                '家族的荣耀',
                '智慧与美德的化身'
            ];
            
            return titles[Math.floor(Math.random() * titles.length)];
        }
        
        // 生成自传
        function generateAutobiography() {
            // 根据游戏数据生成自传
            const autobiography = `
我，${window.gameData.protagonist.name}，生于${window.gameData.family.reignYear}年间，出身于${window.gameData.family.familyStatus}。父亲${window.gameData.parents[0].name}是一位${window.gameData.parents[0].job}，母亲${window.gameData.parents[1].name}是一位${window.gameData.parents[1].job}。我在家中排行${window.gameData.protagonist.rank}，有四位姐妹。

从小，父亲就教我读书写字，母亲教我女红烹饪。我生性${window.gameData.protagonist.personality}，喜欢${getFavoriteSkill()}。在我${getMarriageAge()}岁那年，我嫁给了${getHusbandDescription()}。

婚后，我相夫教子，勤俭持家。我生了${getChildCount()}个孩子，他们都很争气，有的${getChildrenAchievement()}。

我一生最大的遗憾是${getRegret()}，最大的满足是${getSatisfaction()}。

回顾我的一生，虽然平凡，但我过得很充实，很幸福。我感谢父母的养育之恩，感谢姐妹们的陪伴，感谢丈夫的爱护，感谢孩子们的孝顺。

我相信，一个人的价值不在于地位的高低，财富的多少，而在于是否活得有意义，是否给家人带来幸福。我希望我的子孙后代都能明白这个道理，做一个对社会有用的人。

${window.gameData.family.reignYear}${window.gameData.time.year}年，${window.gameData.protagonist.age}岁
${window.gameData.protagonist.name}手书
            `;
            
            return autobiography.trim();
        }
        
        // 获取最喜欢的技能
        function getFavoriteSkill() {
            if (window.gameData.protagonist.skills.length === 0) {
                return '读书写字';
            }
            
            // 找出等级最高的技能
            const favoriteSkill = window.gameData.protagonist.skills.reduce((max, skill) => 
                skill.level > max.level ? skill : max, window.gameData.protagonist.skills[0]);
            
            return favoriteSkill.name;
        }
        
        // 获取结婚年龄
        function getMarriageAge() {
            // 根据游戏进程计算结婚年龄
            if (window.gameData.married) {
                return window.gameData.marriageAge;
            } else {
                return Math.floor(Math.random() * 6) + 18; // 18-24岁
            }
        }
        
        // 获取丈夫描述
        function getHusbandDescription() {
            // 根据游戏进程生成丈夫描述
            const descriptions = [
                '一位温柔体贴的书生',
                '一位事业有成的商人',
                '一位公正廉洁的官员',
                '一位才华横溢的诗人',
                '一位武艺高强的将军'
            ];
            
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }
        
        // 获取子女数量
        function getChildCount() {
            // 根据游戏进程计算子女数量
            return Math.floor(Math.random() * 4) + 1; // 1-4个孩子
        }
        
        // 获取子女成就
        function getChildrenAchievement() {
            // 生成子女成就
            const achievements = [
                '考取了功名',
                '成为了富商',
                '嫁入了豪门',
                '成为了名医',
                '著书立说'
            ];
            
            return achievements[Math.floor(Math.random() * achievements.length)];
        }
        
        // 获取遗憾
        function getRegret() {
            // 生成遗憾
            const regrets = [
                '未能多见父母几面',
                '未能好好照顾姐妹们',
                '未能实现自己的理想',
                '未能多学一些技能',
                '未能多出去看看外面的世界'
            ];
            
            return regrets[Math.floor(Math.random() * regrets.length)];
        }
        
        // 获取满足
        function getSatisfaction() {
            // 生成满足
            const satisfactions = [
                '有一个幸福的家庭',
                '培养了优秀的子女',
                '得到了家人的爱戴',
                '学会了很多技能',
                '帮助了很多人'
            ];
            
            return satisfactions[Math.floor(Math.random() * satisfactions.length)];
        }
        
        // 生成家族后世情况
        function generateFamilyFuture() {
            // 生成家族后世情况
            const familyFuture = `
张家后世情况：

父亲${window.gameData.parents[0].name}后来官至${getFatherCareer()}，深受皇帝器重。母亲${window.gameData.parents[1].name}享年${Math.floor(Math.random() * 20) + 60}岁，一生贤惠淑德，深受家人爱戴。

大姐${window.gameData.sisters.find(s => s.rank === '长女').name}嫁给了${getSisterHusband(0)}，婚后生活${getMarriageHappiness()}。二姐${window.gameData.sisters.find(s => s.rank === '次女').name}嫁给了${getSisterHusband(1)}，婚后${getMarriageHappiness()}。

四妹${window.gameData.sisters.find(s => s.rank === '四女').name}嫁给了${getSisterHusband(2)}，婚后${getMarriageHappiness()}。五妹${window.gameData.sisters.find(s => s.rank === '五女').name}嫁给了${getSisterHusband(3)}，婚后${getMarriageHappiness()}。

张家子孙后代人才辈出，有的考取功名，有的经商致富，有的成为名医，有的著书立说。张家的家风得以传承，成为当地的名门望族。
            `;
            
            return familyFuture.trim();
        }
        
        // 获取父亲的最终官职
        function getFatherCareer() {
            // 根据初始官职生成最终官职
            const careers = [
                '宰相',
                '尚书',
                '侍郎',
                '巡抚',
                '知府'
            ];
            
            return careers[Math.floor(Math.random() * careers.length)];
        }
        
        // 获取姐妹的丈夫
        function getSisterHusband(index) {
            // 生成姐妹的丈夫
            const husbands = [
                '一位官员',
                '一位商人',
                '一位书生',
                '一位将军',
                '一位名医'
            ];
            
            return husbands[Math.floor(Math.random() * husbands.length)];
        }
        
        // 获取婚姻幸福程度
        function getMarriageHappiness() {
            // 生成婚姻幸福程度
            const happiness = [
                '幸福美满',
                '相敬如宾',
                '平平淡淡',
                '时有争吵',
                '不太和谐'
            ];
            
            return happiness[Math.floor(Math.random() * happiness.length)];
        }
        
        // 显示结局模态框
        function showEndingModal(ending) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = ending.title;
            modalBody.innerHTML = `
                <div class="ending-content">
                    <div class="ending-info">
                        <p><strong>享年:</strong> ${ending.age}岁</p>
                        <p><strong>日期:</strong> ${ending.date}</p>
                    </div>
                    <div class="autobiography">
                        <h4>自传</h4>
                        <p>${ending.content.replace(/\n/g, '</p><p>')}</p>
                    </div>
                    <div class="family-future">
                        <h4>家族后世</h4>
                        <p>${ending.familyFuture.replace(/\n/g, '</p><p>')}</p>
                    </div>
                </div>
            `;
            modalFooter.innerHTML = `
                <button class="btn btn-primary" onclick="restartGame()">
                    <i class="fas fa-redo"></i> 开始新人生
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> 返回主页
                </button>
            `;
            
            showModal();
        }
        
        // 查看全部技能
        function showAllSkills() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '全部技能';
            
            let skillsHtml = '<div class="skills-grid">';
            window.gameData.protagonist.skills.forEach(skill => {
                skillsHtml += `
                    <div class="skill-card">
                        <h4>${skill.name}</h4>
                        <div class="attribute-bar">
                            <div class="attribute-fill" style="width: ${skill.level}%"></div>
                            <span class="attribute-value">${skill.level}</span>
                        </div>
                    </div>
                `;
            });
            skillsHtml += '</div>';
            
            modalBody.innerHTML = skillsHtml;
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 查看人物详情
        function viewCharacterDetail(name) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = `${name} - 人物详情`;
            
            // 查找人物信息
            let character = null;
            
            // 检查是否是主角
            if (name === window.gameData.protagonist.name) {
                character = {
                    ...window.gameData.protagonist,
                    type: 'protagonist'
                };
            }
            // 检查是否是父母
            else {
                character = window.gameData.parents.find(p => p.name === name);
                if (character) character.type = 'parent';
            }
            
            // 检查是否是姐妹
            if (!character) {
                character = window.gameData.sisters.find(s => s.name === name);
                if (character) character.type = 'sister';
            }
            
            // 如果找不到人物，显示错误信息
            if (!character) {
                modalBody.innerHTML = '<p>未找到该人物信息</p>';
                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
                `;
                showModal();
                return;
            }
            
            // 生成人物详情HTML
            let detailHtml = `
                <div class="character-detail">
                    <div class="character-header">
                        <h3>${character.name}</h3>
                        <span class="character-age">${character.age}岁</span>
                    </div>
                    <div class="character-info">
                        <p><strong>身份:</strong> ${getCharacterIdentity(character)}</p>
                        <p><strong>性格:</strong> ${character.personality}</p>
            `;
            
            // 根据人物类型添加不同信息
            if (character.type === 'protagonist') {
                detailHtml += `
                        <p><strong>容貌:</strong> ${character.appearance}分</p>
                        <p><strong>健康值:</strong> ${character.health}%</p>
                        <p><strong>情感状态:</strong> ${character.emotion}%</p>
                `;
            } else if (character.type === 'parent') {
                detailHtml += `
                        <p><strong>官职/职业:</strong> ${character.job}</p>
                        <p><strong>与主角关系:</strong> ${character.relationship}</p>
                `;
            } else if (character.type === 'sister') {
                detailHtml += `
                        <p><strong>排行:</strong> ${character.rank}</p>
                        <p><strong>与主角关系:</strong> ${character.relationship}</p>
                `;
                
                // 如果有技能，显示技能
                if (character.skills && character.skills.length > 0) {
                    detailHtml += '<p><strong>技能:</strong></p><div class="skills-list">';
                    character.skills.forEach(skill => {
                        detailHtml += `
                            <div class="skill-item">
                                <span class="skill-name">${skill.name}</span>
                                <div class="attribute-bar small">
                                    <div class="attribute-fill" style="width: ${skill.level}%"></div>
                                    <span class="attribute-value">${skill.level}</span>
                                </div>
                            </div>
                        `;
                    });
                    detailHtml += '</div>';
                }
            }
            
            detailHtml += `
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = detailHtml;
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 获取人物身份
        function getCharacterIdentity(character) {
            if (character.type === 'protagonist') {
                return `${window.gameData.family.familyStatus}之女`;
            } else if (character.type === 'parent') {
                return character.job;
            } else if (character.type === 'sister') {
                return `${window.gameData.family.familyStatus}之女`;
            }
            return '未知';
        }
        
        // 查看全部事件记录
        function viewAllRecords() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '全部事件记录';
            
            if (window.gameData.events.length === 0) {
                modalBody.innerHTML = '<p>暂无事件记录</p>';
            } else {
                let recordsHtml = '<div class="event-records-list">';
                window.gameData.events.reverse().forEach(event => {
                    let eventType = '';
                    switch (event.type) {
                        case 'yearly':
                            eventType = '年度事件';
                            break;
                        case 'interaction':
                            eventType = `与${event.target}互动`;
                            break;
                        case 'diary':
                            eventType = '写日记';
                            break;
                        default:
                            eventType = event.title || '事件';
                    }
                    
                    recordsHtml += `
                        <div class="event-record-item">
                            <div class="event-record-header">
                                <span class="event-record-type">${eventType}</span>
                                <span class="event-record-time">${event.season} (${event.year}年)</span>
                            </div>
                            <div class="event-record-content">
                                <p>${event.title || event.description}</p>
                            </div>
                        </div>
                    `;
                });
                recordsHtml += '</div>';
                modalBody.innerHTML = recordsHtml;
            }
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 查看全部书信
        function viewAllLetters() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '全部书信';
            
            if (window.gameData.letters.length === 0) {
                modalBody.innerHTML = '<p>暂无书信</p>';
            } else {
                let lettersHtml = '<div class="letters-list">';
                window.gameData.letters.forEach(letter => {
                    lettersHtml += `
                        <div class="letter-item ${letter.read ? '' : 'unread'}" onclick="readLetter('${letter.id}')">
                            <div class="letter-header">
                                <span class="letter-sender">${letter.sender}</span>
                                <span class="letter-time">${letter.season} (${letter.year}年)</span>
                            </div>
                            <div class="letter-preview">${letter.preview}</div>
                        </div>
                    `;
                });
                lettersHtml += '</div>';
                modalBody.innerHTML = lettersHtml;
            }
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 阅读书信
        function readLetter(letterId) {
            // 查找书信
            const letter = window.gameData.letters.find(l => l.id.toString() === letterId.toString());
            
            if (!letter) return;
            
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = `${letter.sender}的信`;
            
            modalBody.innerHTML = `
                <div class="letter-content">
                    <div class="letter-header">
                        <h4>${letter.title}</h4>
                        <span class="letter-time">${letter.season} (${letter.year}年)</span>
                    </div>
                    <div class="letter-body">
                        <p>${letter.content.replace(/\n/g, '</p><p>')}</p>
                    </div>
                </div>
            `;
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            // 标记为已读
            letter.read = true;
            
            // 更新界面
            updateLetters();
            
            showModal();
        }
        
        // 进入房间
        function enterRoom(roomId) {
            // 查找房间
            const room = window.gameData.homeMap.rooms.find(r => r.id === roomId);
            
            if (!room) return;
            
            // 生成房间事件
            const roomEvent = generateRoomEvent(room);
            
            // 显示事件
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = room.name;
            
            modalBody.innerHTML = `
                <div class="room-event">
                    <div class="room-description">
                        <p>${room.description}</p>
                    </div>
                    <div class="event-content">
                        <p>${roomEvent.description}</p>
                    </div>
                </div>
            `;
            
            // 如果有选择项
            if (roomEvent.choices && roomEvent.choices.length > 0) {
                let choicesHtml = '<div class="event-choices">';
                roomEvent.choices.forEach((choice, index) => {
                    choicesHtml += `
                        <button class="btn btn-small choice-btn" onclick="makeRoomChoice(${index}, ${JSON.stringify(roomEvent.effects[index])})">
                            <i class="fas ${choice.icon}"></i> ${choice.text}
                        </button>
                    `;
                });
                choicesHtml += '</div>';
                modalBody.innerHTML += choicesHtml;
            }
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">离开</button>
            `;
            
            showModal();
        }
        
        // 生成房间事件
        function generateRoomEvent(room) {
            // 房间事件列表
            const roomEvents = {
                'main_hall': [
                    {
                        description: '你走进正厅，看到父亲正在和一位客人交谈。他们似乎在讨论一些重要的事情...',
                        choices: [
                            { text: '上前问候', icon: 'greeting', effects: { social: 5, family: 3 } },
                            { text: '悄悄离开', icon: 'door-open', effects: { wisdom: 3 } }
                        ]
                    },
                    {
                        description: '你走进正厅，看到母亲正在整理一些衣物。她看起来有些疲惫...',
                        choices: [
                            { text: '帮忙整理', icon: 'hands-helping', effects: { embroidery: 5, family: 5 } },
                            { text: '询问是否需要休息', icon: 'coffee', effects: { family: 8, emotion: 5 } }
                        ]
                    }
                ],
                'bedroom': [
                    {
                        description: '你回到自己的闺房，看到书桌上有一封信。信没有署名，但字迹很熟悉...',
                        choices: [
                            { text: '打开信件', icon: 'envelope-open', effects: { wisdom: 5, emotion: -5 } },
                            { text: '将信收好', icon: 'lock', effects: { wisdom: 8, courage: 5 } }
                        ]
                    },
                    {
                        description: '你回到自己的闺房，决定做一些女红。最近你在学习一种新的刺绣技巧...',
                        choices: [
                            { text: '认真练习', icon: 'needle', effects: { embroidery: 10, patience: 5 } },
                            { text: '尝试创新', icon: 'lightbulb', effects: { embroidery: 5, creativity: 10 } }
                        ]
                    }
                ],
                'garden': [
                    {
                        description: '你走进花园，看到各种花草树木。春天的花园格外美丽，桃花、杏花竞相开放...',
                        choices: [
                            { text: '欣赏美景', icon: 'camera', effects: { emotion: 10, painting: 5 } },
                            { text: '帮忙浇水', icon: 'tint', effects: { health: 5, patience: 5 } }
                        ]
                    },
                    {
                        description: '你走进花园，看到四妹正在追逐一只蝴蝶。她玩得很开心...',
                        choices: [
                            { text: '加入她', icon: 'child', effects: { emotion: 8, family: 5 } },
                            { text: '教她认识花草', icon: 'leaf', effects: { wisdom: 5, family: 8 } }
                        ]
                    }
                ],
                'study': [
                    {
                        description: '你走进书房，看到书架上摆满了各种书籍。父亲的书房是你最喜欢的地方之一...',
                        choices: [
                            { text: '阅读诗词', icon: 'book', effects: { poetry: 10, wisdom: 5 } },
                            { text: '阅读历史', icon: 'landmark', effects: { wisdom: 10, knowledge: 5 } }
                        ]
                    },
                    {
                        description: '你走进书房，看到父亲正在写字。他的书法很好，你一直很想学...',
                        choices: [
                            { text: '请求指导', icon: 'chalkboard-teacher', effects: { calligraphy: 10, family: 5 } },
                            { text: '在一旁观看', icon: 'eye', effects: { calligraphy: 5, wisdom: 5 } }
                        ]
                    }
                ],
                'kitchen': [
                    {
                        description: '你走进厨房，看到母亲和丫鬟们正在准备晚饭。厨房飘着阵阵香气...',
                        choices: [
                            { text: '帮忙做饭', icon: 'utensils', effects: { cooking: 10, family: 5 } },
                            { text: '帮忙准备食材', icon: 'carrot', effects: { cooking: 5, health: 5 } }
                        ]
                    },
                    {
                        description: '你走进厨房，看到五妹正在偷吃点心。她看到你，立刻停下了手...',
                        choices: [
                            { text: '和她一起吃', icon: 'cookie', effects: { emotion: 5, family: 3 } },
                            { text: '告诉她要先洗手', icon: 'hand-sparkles', effects: { wisdom: 5, family: 5 } }
                        ]
                    }
                ],
                'ancestral_hall': [
                    {
                        description: '你走进祠堂，看到祖先的牌位。这里庄严肃穆，让人不禁心生敬畏...',
                        choices: [
                            { text: '虔诚祭拜', icon: 'pray', effects: { luck: 10, family: 5 } },
                            { text: '擦拭牌位', icon: 'broom', effects: { patience: 5, family: 10 } }
                        ]
                    },
                    {
                        description: '你走进祠堂，看到父亲正在上香。他看起来很严肃...',
                        choices: [
                            { text: '上前帮忙', icon: 'hand-holding', effects: { family: 10, wisdom: 5 } },
                            { text: '默默祈祷', icon: 'pray', effects: { luck: 8, wisdom: 3 } }
                        ]
                    }
                ]
            };
            
            // 获取房间事件
            const events = roomEvents[room.id] || [];
            
            // 随机选择一个事件
            return events[Math.floor(Math.random() * events.length)] || {
                description: `你走进了${room.name}。`,
                choices: []
            };
        }
        
        // 做出房间选择
        function makeRoomChoice(choiceIndex, effects) {
            // 应用效果
            applyEffects(effects);
            
            // 关闭模态框
            closeModal();
            
            // 显示提示
            showToast('你做出了选择，获得了一些经验！', 'success');
            
            // 保存游戏
            saveGame(1);
        }
        
        // 写日记
        function writeDiary() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '写日记';
            
            // 检查是否已有日记
            const currentDiary = window.gameData.events.find(
                event => event.type === 'diary' && 
                event.year === window.gameData.time.year && 
                event.season === window.gameData.time.season
            );
            
            modalBody.innerHTML = `
                <div class="diary-editor">
                    <textarea id="diary-textarea" placeholder="写下你这个季节的心情和经历..." rows="10">${currentDiary ? currentDiary.content : ''}</textarea>
                </div>
            `;
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="saveDiary()">保存</button>
            `;
            
            showModal();
        }
        
        // 保存日记
        function saveDiary() {
            const diaryContent = document.getElementById('diary-textarea').value.trim();
            
            if (!diaryContent) {
                showToast('日记内容不能为空！', 'error');
                return;
            }
            
            // 检查是否已有日记
            const diaryIndex = window.gameData.events.findIndex(
                event => event.type === 'diary' && 
                event.year === window.gameData.time.year && 
                event.season === window.gameData.time.season
            );
            
            const diaryEvent = {
                id: diaryIndex !== -1 ? window.gameData.events[diaryIndex].id : Date.now(),
                time: Date.now(),
                year: window.gameData.time.year,
                season: window.gameData.time.season,
                type: 'diary',
                content: diaryContent
            };
            
            // 更新或添加日记
            if (diaryIndex !== -1) {
                window.gameData.events[diaryIndex] = diaryEvent;
            } else {
                window.gameData.events.push(diaryEvent);
            }
            
            // 更新界面
            updateDiary();
            updateEventRecords();
            
            // 关闭模态框
            closeModal();
            
            // 显示提示
            showToast('日记保存成功！', 'success');
            
            // 保存游戏
            saveGame(1);
        }
        
        // 查看人物关系
        function viewRelationships() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '人物关系';
            
            let relationshipsHtml = '<div class="relationships-list">';
            
            // 显示家人关系
            if (window.gameData.relationships.family.length > 0) {
                relationshipsHtml += '<h4>家人</h4>';
                window.gameData.relationships.family.forEach(relation => {
                    relationshipsHtml += `
                        <div class="relationship-item">
                            <div class="relationship-info">
                                <span class="relationship-name">${relation.name}</span>
                                <span class="relationship-type">${relation.type}</span>
                            </div>
                            <div class="relationship-intimacy">
                                <div class="attribute-bar">
                                    <div class="attribute-fill" style="width: ${relation.intimacy}%"></div>
                                    <span class="attribute-value">${relation.intimacy}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // 显示朋友关系
            if (window.gameData.relationships.friends.length > 0) {
                relationshipsHtml += '<h4>朋友</h4>';
                window.gameData.relationships.friends.forEach(relation => {
                    relationshipsHtml += `
                        <div class="relationship-item">
                            <div class="relationship-info">
                                <span class="relationship-name">${relation.name}</span>
                                <span class="relationship-type">${relation.type}</span>
                            </div>
                            <div class="relationship-intimacy">
                                <div class="attribute-bar">
                                    <div class="attribute-fill" style="width: ${relation.intimacy}%"></div>
                                    <span class="attribute-value">${relation.intimacy}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            relationshipsHtml += '</div>';
            
            modalBody.innerHTML = relationshipsHtml;
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 查看技能和资产
        function viewSkills() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '技能和资产';
            
            // 技能部分
            let skillsHtml = '<h4>技能</h4><div class="skills-grid">';
            window.gameData.protagonist.skills.forEach(skill => {
                skillsHtml += `
                    <div class="skill-card">
                        <h5>${skill.name}</h5>
                        <div class="attribute-bar">
                            <div class="attribute-fill" style="width: ${skill.level}%"></div>
                            <span class="attribute-value">${skill.level}</span>
                        </div>
                    </div>
                `;
            });
            skillsHtml += '</div>';
            
            // 资产部分
            let assetsHtml = '<h4>资产</h4><div class="assets-list">';
            assetsHtml += `<div class="asset-item"><span class="asset-name">银两:</span><span class="asset-value">${window.gameData.assets.money}两</span></div>`;
            
            if (window.gameData.assets.properties.length > 0) {
                assetsHtml += '<div class="asset-item"><span class="asset-name">房产:</span><span class="asset-value">';
                assetsHtml += window.gameData.assets.properties.join(', ');
                assetsHtml += '</span></div>';
            }
            
            if (window.gameData.assets.jewelry.length > 0) {
                assetsHtml += '<div class="asset-item"><span class="asset-name">首饰:</span><span class="asset-value">';
                assetsHtml += window.gameData.assets.jewelry.join(', ');
                assetsHtml += '</span></div>';
            }
            
            if (window.gameData.assets.clothes.length > 0) {
                assetsHtml += '<div class="asset-item"><span class="asset-name">衣物:</span><span class="asset-value">';
                assetsHtml += window.gameData.assets.clothes.join(', ');
                assetsHtml += '</span></div>';
            }
            
            assetsHtml += '</div>';
            
            modalBody.innerHTML = skillsHtml + assetsHtml;
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 查看事件回顾
        function viewEvents() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '事件回顾';
            
            if (window.gameData.events.length === 0) {
                modalBody.innerHTML = '<p>暂无事件记录</p>';
            } else {
                let eventsHtml = '<div class="events-timeline">';
                
                // 按年份和季节分组
                const eventsByYear = {};
                
                window.gameData.events.forEach(event => {
                    if (!eventsByYear[event.year]) {
                        eventsByYear[event.year] = {};
                    }
                    
                    if (!eventsByYear[event.year][event.season]) {
                        eventsByYear[event.year][event.season] = [];
                    }
                    
                    eventsByYear[event.year][event.season].push(event);
                });
                
                // 生成时间线
                for (let year in eventsByYear) {
                    eventsHtml += `<div class="timeline-year"><h4>${window.gameData.family.reignYear}${year}年</h4></div>`;
                    
                    const seasons = ['春季', '夏季', '秋季', '冬季'];
                    
                    seasons.forEach(season => {
                        if (eventsByYear[year][season] && eventsByYear[year][season].length > 0) {
                            eventsHtml += `<div class="timeline-season"><h5>${season}</h5></div>`;
                            
                            eventsByYear[year][season].forEach(event => {
                                let eventType = '';
                                switch (event.type) {
                                    case 'yearly':
                                        eventType = '年度事件';
                                        break;
                                    case 'interaction':
                                        eventType = `与${event.target}互动`;
                                        break;
                                    case 'diary':
                                        eventType = '写日记';
                                        break;
                                    default:
                                        eventType = event.title || '事件';
                                }
                                
                                eventsHtml += `
                                    <div class="timeline-event">
                                        <div class="event-type">${eventType}</div>
                                        <div class="event-title">${event.title || event.description.substring(0, 30) + '...'}</div>
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                eventsHtml += '</div>';
                modalBody.innerHTML = eventsHtml;
            }
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
            `;
            
            showModal();
        }
        
        // 重开新人生
        function restartGame() {
            if (confirm('确定要重开新人生吗？当前进度将会丢失！')) {
                showToast('正在准备新的人生...', 'info');
                setTimeout(() => {
                    // 清除游戏数据
                    window.gameData = null;
                    
                    // 清除本地存储
                    localStorage.removeItem('game_save_1');
                    localStorage.removeItem('game_save_2');
                    localStorage.removeItem('game_save_3');
                    
                    // 跳转到角色创建页面
                    window.location.href = 'create-role.html';
                }, 1000);
            }
        }
        
        // 获取相对时间
        function getRelativeTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            // 小于1天
            if (diff < 86400000) {
                return '昨日';
            }
            // 小于7天
            else if (diff < 604800000) {
                return `${Math.floor(diff / 86400000)}天前`;
            }
            // 小于30天
            else if (diff < 2592000000) {
                return `${Math.floor(diff / 604800000)}周前`;
            }
            // 大于30天
            else {
                return `${Math.floor(diff / 2592000000)}个月前`;
            }
        }
        
        // 显示存档对话框
        function showSaveDialog() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '保存游戏';
            
            // 获取存档信息
            const saveInfo1 = getSaveInfo(1);
            const saveInfo2 = getSaveInfo(2);
            const saveInfo3 = getSaveInfo(3);
            
            modalBody.innerHTML = `
                <div class="save-slots">
                    <div class="save-slot" onclick="saveGame(1)">
                        <div class="save-slot-header">
                            <h4>存档位 1</h4>
                            <span class="save-status ${saveInfo1 ? 'saved' : 'empty'}">${saveInfo1 ? '已保存' : '空'}</span>
                        </div>
                        ${saveInfo1 ? `
                            <div class="save-info">
                                <p><strong>角色:</strong> ${saveInfo1.protagonist.name}</p>
                                <p><strong>年龄:</strong> ${saveInfo1.protagonist.age}岁</p>
                                <p><strong>时间:</strong> ${saveInfo1.family.reignYear}${saveInfo1.time.year}年 ${saveInfo1.time.season}</p>
                                <p><strong>保存时间:</strong> ${new Date(saveInfo1.saveTime).toLocaleString()}</p>
                            </div>
                        ` : '<div class="save-empty">点击保存新游戏</div>'}
                    </div>
                    <div class="save-slot" onclick="saveGame(2)">
                        <div class="save-slot-header">
                            <h4>存档位 2</h4>
                            <span class="save-status ${saveInfo2 ? 'saved' : 'empty'}">${saveInfo2 ? '已保存' : '空'}</span>
                        </div>
                        ${saveInfo2 ? `
                            <div class="save-info">
                                <p><strong>角色:</strong> ${saveInfo2.protagonist.name}</p>
                                <p><strong>年龄:</strong> ${saveInfo2.protagonist.age}岁</p>
                                <p><strong>时间:</strong> ${saveInfo2.family.reignYear}${saveInfo2.time.year}年 ${saveInfo2.time.season}</p>
                                <p><strong>保存时间:</strong> ${new Date(saveInfo2.saveTime).toLocaleString()}</p>
                            </div>
                        ` : '<div class="save-empty">点击保存新游戏</div>'}
                    </div>
                    <div class="save-slot" onclick="saveGame(3)">
                        <div class="save-slot-header">
                            <h4>存档位 3</h4>
                            <span class="save-status ${saveInfo3 ? 'saved' : 'empty'}">${saveInfo3 ? '已保存' : '空'}</span>
                        </div>
                        ${saveInfo3 ? `
                            <div class="save-info">
                                <p><strong>角色:</strong> ${saveInfo3.protagonist.name}</p>
                                <p><strong>年龄:</strong> ${saveInfo3.protagonist.age}岁</p>
                                <p><strong>时间:</strong> ${saveInfo3.family.reignYear}${saveInfo3.time.year}年 ${saveInfo3.time.season}</p>
                                <p><strong>保存时间:</strong> ${new Date(saveInfo3.saveTime).toLocaleString()}</p>
                            </div>
                        ` : '<div class="save-empty">点击保存新游戏</div>'}
                    </div>
                </div>
            `;
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            `;
            
            showModal();
        }
        
        // 显示读档对话框
        function showLoadDialog() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');
            
            modalTitle.textContent = '读取游戏';
            
            // 获取存档信息
            const saveInfo1 = getSaveInfo(1);
            const saveInfo2 = getSaveInfo(2);
            const saveInfo3 = getSaveInfo(3);
            
            // 检查是否有存档
            const hasSaves = saveInfo1 || saveInfo2 || saveInfo3;
            
            if (!hasSaves) {
                modalBody.innerHTML = '<p>没有找到游戏存档！</p>';
                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">关闭</button>
                `;
            } else {
                modalBody.innerHTML = `
                    <div class="save-slots">
                        ${saveInfo1 ? `
                            <div class="save-slot" onclick="loadGame(1)">
                                <div class="save-slot-header">
                                    <h4>存档位 1</h4>
                                    <span class="save-status saved">已保存</span>
                                </div>
                                <div class="save-info">
                                    <p><strong>角色:</strong> ${saveInfo1.protagonist.name}</p>
                                    <p><strong>年龄:</strong> ${saveInfo1.protagonist.age}岁</p>
                                    <p><strong>时间:</strong> ${saveInfo1.family.reignYear}${saveInfo1.time.year}年 ${saveInfo1.time.season}</p>
                                    <p><strong>保存时间:</strong> ${new Date(saveInfo1.saveTime).toLocaleString()}</p>
                                </div>
                            </div>
                        ` : ''}
                        ${saveInfo2 ? `
                            <div class="save-slot" onclick="loadGame(2)">
                                <div class="save-slot-header">
                                    <h4>存档位 2</h4>
                                    <span class="save-status saved">已保存</span>
                                </div>
                                <div class="save-info">
                                    <p><strong>角色:</strong> ${saveInfo2.protagonist.name}</p>
                                    <p><strong>年龄:</strong> ${saveInfo2.protagonist.age}岁</p>
                                    <p><strong>时间:</strong> ${saveInfo2.family.reignYear}${saveInfo2.time.year}年 ${saveInfo2.time.season}</p>
                                    <p><strong>保存时间:</strong> ${new Date(saveInfo2.saveTime).toLocaleString()}</p>
                                </div>
                            </div>
                        ` : ''}
                        ${saveInfo3 ? `
                            <div class="save-slot" onclick="loadGame(3)">
                                <div class="save-slot-header">
                                    <h4>存档位 3</h4>
                                    <span class="save-status saved">已保存</span>
                                </div>
                                <div class="save-info">
                                    <p><strong>角色:</strong> ${saveInfo3.protagonist.name}</p>
                                    <p><strong>年龄:</strong> ${saveInfo3.protagonist.age}岁</p>
                                    <p><strong>时间:</strong> ${saveInfo3.family.reignYear}${saveInfo3.time.year}年 ${saveInfo3.time.season}</p>
                                    <p><strong>保存时间:</strong> ${new Date(saveInfo3.saveTime).toLocaleString()}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                `;
            }
            
            showModal();
        }
    </script>
</body>
</html>